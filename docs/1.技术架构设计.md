# 音视频转写与 AI 总结工具 - 技术架构设计

## 1. 总体架构

### 1.1 系统概述

本项目采用 **前后端分离架构**：
- **后端服务**: 运行在 Windows 主机上，提供 RESTful API，负责 AI 处理
- **前端应用**: 纯 Web 应用，通过浏览器访问，支持局域网内所有设备
- **部署方式**: 局域网部署，家庭网络使用

### 1.2 架构图

```mermaid
graph TD
    %% 客户端层
    subgraph Client [客户端层 (Browser)]
        React[React SPA]
        Zustand[Zustand Store]
        SmartPoll[Smart Polling]

        React --> Zustand
        Zustand --> SmartPoll
    end

    %% API 服务层
    subgraph Server [服务端层 (Windows Host)]
        subgraph APIGateway [API Gateway (Node.js)]
            Fastify[Fastify Server]
            UploadMgr[Upload Handler]
            QueueMgr[Queue Manager (Persistent)]

            Fastify --> UploadMgr
            Fastify --> QueueMgr
        end

        subgraph Storage [存储层]
            SQLite[(SQLite DB)]
            FS[File System]
            Diag[Diagnostics]
        end

        subgraph AI_Engine [AI 引擎层 (Python)]
            subgraph WorkerProcess [Persistent Worker Process]
                Controller[Worker Controller]
                Whisper[Faster-Whisper (CUDA)]
                Model[Model Singleton (Large-v3)]

                Controller --> Whisper
                Whisper --> Model
            end

            FFmpeg[FFmpeg / FFprobe]
        end
    end

    %% 交互关系
    SmartPoll -- HTTP/REST --> Fastify
    UploadMgr -- Save File --> FS
    QueueMgr -- Task State --> SQLite
    QueueMgr -- Extract Audio --> FFmpeg
    FFmpeg -- WAV File --> FS

    %% 核心 Worker 交互 (StdIO Pipe)
    QueueMgr -- JSON (stdin) --> Controller
    Controller -- JSON (stdout) --> QueueMgr

    %% 诊断备份
    QueueMgr -. Backup Failure .-> Diag
```

*说明：*
1.  **单例 Worker**: Python 进程在 API 服务启动时加载，模型常驻内存，避免重复初始化。
2.  **标准输入/输出通信**: Queue Manager 通过 `stdin` 发送任务，Worker 通过 `stdout` 返回结果，实现零网络开销的高效 IPC。
3.  **智能轮询**: 前端根据任务预估时长智能调整轮询频率，减轻服务器压力。


### 1.3 技术栈选型

#### 前端层（Web 应用）
- **框架**: React 18 + TypeScript 5.x
- **UI 组件库**: Ant Design / shadcn/ui
- **状态管理**: Zustand
- **样式方案**: Tailwind CSS
- **构建工具**: Vite
- **HTTP 客户端**: axios
- **实时通信**: 智能轮询 (Smart Polling) / WebSocket (Socket.io)

#### 后端层（API 服务器）
- **框架**: Fastify (Node.js 18+)
- **语言**: TypeScript 5.x
- **文件上传**: @fastify/multipart
- **任务队列**: 内存队列 + SQLite 持久化状态
- **进程管理**: Node.js Child Process (Spawn)

#### AI 处理层
- **运行时**: Python 3.10+
- **语音识别**: faster-whisper (GPU 加速, Standalone Process)
- **LLM 推理**: Ollama + Qwen3-14B
- **音视频处理**: FFmpeg
- **进程通信**: stdin/stdout (JSON lines)

#### 数据存储层
- **数据库**: SQLite (better-sqlite3)
- **文件存储**: 本地文件系统

## 2. 核心技术方案

### 2.1 语音识别（ASR）方案

**采用方案**: **faster-whisper + CUDA (Persistent Worker)**

**架构变更说明 (2025-03)**:
为了解决 Windows 下 CUDA 多进程初始化导致的崩溃问题 (Error 3221226505)，我们将 Worker 架构调整为 **常驻单例模式**。

**设计要点**:
1.  **单例模式**: Node.js 启动一个 Python 进程 (`worker.py --server`)，该进程在启动时加载模型，之后常驻内存。
2.  **交互协议**: Node.js 通过 `stdin` 发送 JSON 任务，Python 通过 `stdout` 返回 JSON 结果。
3.  **并发控制**: 队列层确保同一时间只有一个转写任务发送给 Worker（串行处理），避免 GPU 显存竞争。
4.  **环境感知**: 支持通过环境变量 `WHISPER_DEVICE` (cuda/cpu) 和 `WHISPER_COMPUTE_TYPE` (float16/int8) 动态配置。

**推荐配置**:
- 模型: `large-v3`
- 设备: `cuda`
- 精度: `float16` (默认) 或 `int8` (如显存受限)

### 2.2 任务状态与轮询优化

**状态机**:
`uploaded` -> `extracting` -> `transcribing` -> `completed` / `error`

**智能轮询策略 (Smart Polling)**:
为了减少服务器压力并保证实时性，前端采用了基于预估时间的动态轮询策略，替代了简单的固定间隔轮询。
1.  **精准时长**: 后端使用 `ffprobe` 获取精确的音视频时长 (`duration`) 并返回给前端。
2.  **动态间隔**:
    - 剩余时间 > 20s: 每 5s 轮询 (省流)
    - 剩余时间 > 10s: 每 2s 轮询
    - 剩余时间 < 10s: 每 0.5s 轮询 (冲刺)
3.  **即时反馈**: 任务完成瞬间，用户能感觉到几乎无延迟的状态更新。

### 2.3 错误诊断机制

系统内置了自动诊断功能：
1.  **崩溃捕获**: 捕获 Python 进程异常退出码。
2.  **现场保留**: 任务失败时，自动将对应的音频文件复制到 `diagnostics` 目录，保留文件名、时间戳和任务ID。
3.  **日志增强**: 记录详细的文件大小、修改时间和处理耗时。

## 3. 数据存储设计

### 3.1 数据模型

```typescript
interface Project {
  id: string;
  name: string;
  sourceFile: string;        // 原始文件路径
  audioFile?: string;        // 提取的音频文件
  createdAt: Date;
  updatedAt: Date;
  status: 'pending' | 'processing' | 'completed' | 'error';
  transcription?: Transcription;
  summary?: Summary;
  tags: string[];
  metadata: {
    duration: number;
    language: string;
    fileSize: number;
  };
}

interface Transcription {
  language: string;
  segments: TranscriptionSegment[];
  fullText: string;
}

interface TranscriptionSegment {
  id: string;
  start: number;
  end: number;
  text: string;
  confidence: number;
  speaker?: string;  // 说话人标识（未来功能）
}

interface Summary {
  abstract: string;          // 摘要
  keyPoints: string[];       // 要点
  entities: {                // 实体识别
    people: string[];
    places: string[];
    dates: string[];
  };
  topics: string[];          // 主题标签
  generatedAt: Date;
}
```

### 3.2 存储方案

**本地数据库: SQLite**
```sql
-- projects 表
CREATE TABLE projects (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  source_file TEXT NOT NULL,
  audio_file TEXT,
  status TEXT NOT NULL, -- uploaded, extracting, ready_to_transcribe, transcribing, transcribed, summarizing, completed, error
  error_message TEXT,   -- 错误信息
  failed_stage TEXT,    -- 失败阶段
  created_at DATETIME,
  updated_at DATETIME,
  metadata TEXT  -- JSON 格式
);

-- transcriptions 表
CREATE TABLE transcriptions (
  id TEXT PRIMARY KEY,
  project_id TEXT REFERENCES projects(id),
  language TEXT,
  full_text TEXT,
  segments TEXT  -- JSON 格式
);

-- summaries 表
CREATE TABLE summaries (
  id TEXT PRIMARY KEY,
  project_id TEXT REFERENCES projects(id),
  abstract TEXT,
  key_points TEXT,  -- JSON 数组
  entities TEXT,    -- JSON 对象
  generated_at DATETIME
);
```

**大文件存储**: 文件系统
- 音视频文件：保持原始位置或复制到应用数据目录
- 提取的音频：临时目录，处理完成后可选择删除

## 4. 部署架构

### 4.1 服务端部署（Windows）

#### 系统要求
- **操作系统**: Windows 10/11 (x64)
- **硬件**: i5-13600KF + RTX 4070 TI Super（或同等配置）
- **软件依赖**:
  - Node.js 18+
  - Python 3.10+
  - CUDA 11.8+ & cuDNN
  - FFmpeg
  - Ollama

#### 部署方式

**方式 1: 开发模式**
```bash
# 后端
cd server
npm install
npm run dev

# 前端
cd web
npm install
npm run dev
```

**方式 2: 生产模式（PM2）**
```bash
# 安装 PM2
npm install -g pm2

# 构建前端
cd web
npm run build

# 启动后端（自动服务前端静态文件）
cd server
pm2 start ecosystem.config.js

# 开机自启动
pm2 startup
pm2 save
```

### 4.2 客户端访问

#### 浏览器兼容性
- Chrome 90+
- Edge 90+
- Firefox 88+
- Safari 14+

#### 访问方式
- **本机访问**: `http://localhost:8080`
- **局域网访问**: `http://192.168.x.x:8080`
  - 需要在 Windows 防火墙中开放 8080 端口
  - 或使用自定义域名（配置 hosts 文件）

## 5. 性能优化策略

### 5.1 GPU 加速优化
- **单例复用**: 避免了每次任务启动 Python 解释器和加载 CUDA 库的开销（~3-5秒），处理短音频时优势巨大。
- **显存管理**: 串行处理确保显存占用稳定。
- **混合精度**: 默认使用 float16，平衡速度与显存。

### 5.2 轮询优化
- 通过智能轮询减少了 90% 以上的无效 HTTP 请求。

### 5.3 内存与缓存
- 大文件流式处理
- 转写结果持久化缓存

## 6. 安全与隐私

### 6.1 数据隐私
- ✅ 所有处理完全本地化
- ✅ 不连接外部服务器
- ✅ 敏感数据加密存储（可选功能）

### 6.2 网络安全
- 简单的 Token 认证（可选）
- 严格的 CORS 策略（仅限局域网）
- Windows 防火墙配置
