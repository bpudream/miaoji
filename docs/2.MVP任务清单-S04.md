# Sprint 4: WebSocket 实时通信与 LLM 集成（Week 9-10）

### 目标
实现 WebSocket 实时推送和 AI 总结功能

### User Stories

#### US-4.1 WebSocket 服务端
**作为** 后端开发者
**我想要** WebSocket 实时通信
**以便** 推送转写进度

**验收标准**:
- [ ] Socket.io 服务正常运行
- [ ] 支持房间（room）管理
- [ ] 连接状态管理完善

**任务拆解**:
- [ ] Task-4.1.1: 安装 socket.io（30min）
  ```bash
  npm install socket.io
  ```
- [ ] Task-4.1.2: 集成 Socket.io 到 Fastify（2h）
- [ ] Task-4.1.3: 实现房间管理（2h）
  - 用户加入项目房间
  - 订阅/取消订阅
- [ ] Task-4.1.4: 实现进度推送（2h）
  ```typescript
  io.to(projectId).emit('progress', { stage, progress });
  ```
- [ ] Task-4.1.5: 连接认证（可选）（1h）

---

#### US-4.2 WebSocket 客户端
**作为** 前端开发者
**我想要** WebSocket 客户端
**以便** 接收实时更新

**验收标准**:
- [ ] 自动连接和重连
- [ ] 监听进度事件
- [ ] 错误处理完善

**任务拆解**:
- [ ] Task-4.2.1: 安装 socket.io-client（15min）
- [ ] Task-4.2.2: 创建 WebSocket 服务类（2h）
  ```typescript
  class WebSocketService {
    connect()
    subscribeToProject(projectId)
    onProgress(callback)
  }
  ```
- [ ] Task-4.2.3: 实现自动重连（1h）
- [ ] Task-4.2.4: 集成到 Zustand store（1h）
- [ ] Task-4.2.5: 添加连接状态指示器（1h）

---

#### US-4.3 实时进度显示
**作为** 用户
**我想要** 看到实时的转写进度
**以便** 了解处理状态

**验收标准**:
- [ ] 进度百分比实时更新
- [ ] 显示当前处理阶段
- [ ] 估算剩余时间

**任务拆解**:
- [ ] Task-4.3.1: 修改转写流程发送进度（2h）
  - 音频提取进度
  - 转写进度
- [ ] Task-4.3.2: 创建进度组件（2h）
  ```tsx
  <ProgressBar
    progress={progress}
    stage={stage}
  />
  ```
- [ ] Task-4.3.3: 实现阶段指示器（1h）
  - 音频提取 -> 转写中 -> 完成
- [ ] Task-4.3.4: 添加剩余时间估算（2h）

---

#### US-4.4 Ollama LLM 集成
**作为** 后端开发者
**我想要** 集成 Ollama 服务
**以便** 实现 AI 总结功能

**验收标准**:
- [ ] Ollama 服务自动管理
- [ ] API 调用正常工作
- [ ] 支持流式输出

**任务拆解**:
- [ ] Task-4.4.1: 创建 OllamaService 类（3h）
  ```typescript
  class OllamaService {
    async ensureRunning()
    async generate(prompt)
    async generateStream(prompt)
  }
  ```
- [ ] Task-4.4.2: 实现 Prompt 模板（2h）
  - 摘要生成 prompt
  - 要点提取 prompt
- [ ] Task-4.4.3: 实现流式输出（2h）
- [ ] Task-4.4.4: 错误处理和重试（2h）
- [ ] Task-4.4.5: 性能优化（1h）

---

#### US-4.5 AI 总结 API
**作为** 前端开发者
**我想要** 调用 AI 总结 API
**以便** 生成内容摘要

**验收标准**:
- [ ] POST /api/projects/:id/summarize
- [ ] 支持不同总结类型
- [ ] 返回结构化结果

**任务拆解**:
- [ ] Task-4.5.1: 实现总结 API 接口（3h）
- [ ] Task-4.5.2: 实现不同总结模式（3h）
  - 简短摘要
  - 详细摘要
  - 要点提取
- [ ] Task-4.5.3: 保存总结结果到数据库（1h）
- [ ] Task-4.5.4: 实现获取总结结果接口（1h）
  - GET /api/projects/:id/summary

---

#### US-4.6 总结结果展示
**作为** 用户
**我想要** 查看 AI 生成的总结
**以便** 快速了解内容要点

**验收标准**:
- [ ] 显示摘要内容
- [ ] 显示要点列表
- [ ] 支持重新生成

**任务拆解**:
- [ ] Task-4.6.1: 创建 SummaryPanel 组件（3h）
  ```tsx
  <SummaryPanel
    summary={summary}
    onRegenerate={handleRegenerate}
  />
  ```
- [ ] Task-4.6.2: 实现生成按钮和loading状态（1h）
- [ ] Task-4.6.3: 实现总结内容展示（2h）
- [ ] Task-4.6.4: 添加复制和导出功能（1h）
- [ ] Task-4.6.5: 实现流式显示（可选）（2h）

---

**Sprint 4 总结**:
- **总估时**: 约 45-50 小时
- **关键交付物**:
  - ✅ WebSocket 实时通信
  - ✅ AI 总结功能完整

