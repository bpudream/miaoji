# 妙记 MVP 开发任务清单

## 项目概览

**项目目标**: 完成可用的 MVP 版本，实现音视频转写和 AI 总结的核心功能

**开发周期**: 8-10 周（5 个 Sprint）

**团队规模**: 1-2 人

**技术栈**: Windows 后端 (Node.js + Python) + Web 前端 (React)

---

## Sprint 2: AI 处理核心功能（Week 5-6）

### 目标
集成 faster-whisper 和 FFmpeg，实现音频提取和转写功能，并优化任务状态管理。

### User Stories

#### US-2.0 任务状态管理优化
**作为** 开发者
**我想要** 一个健壮的任务状态机
**以便** 精确跟踪处理进度并支持断点重试

**验收标准**:
- [x] 数据库支持细粒度状态（uploaded, extracting, transcribing...）
- [x] QueueService 支持基于状态的分步处理
- [x] 失败任务记录具体的 failed_stage
- [x] 支持从失败阶段重试

**任务拆解**:
- [x] Task-2.0.1: 数据库 Schema 迁移（添加状态字段和错误信息）（1h）
- [x] Task-2.0.2: 重构 QueueService 为状态机模式（3h）
- [x] Task-2.0.3: 实现失败重试接口（1h）

---

#### US-2.1 FFmpeg 音频提取服务
**作为** 系统
**我想要** 从视频中提取音频
**以便** 进行语音识别

**验收标准**:
- [x] 支持多种视频格式
- [x] 输出 16kHz 单声道 WAV
- [x] 提取进度可追踪
- [x] 错误处理完善
- [x] 精确获取媒体时长

**任务拆解**:
- [x] Task-2.1.1: 安装 fluent-ffmpeg（30min）
- [x] Task-2.1.2: 创建 AudioExtractor 服务类（3h）
- [x] Task-2.1.3: 实现进度回调（2h）
- [x] Task-2.1.4: 添加错误处理和重试逻辑（2h）
- [x] Task-2.1.5: 测试不同格式视频（2h）
- [x] Task-2.1.6: 集成 ffprobe 获取精确 duration（1h） - **[New]**

---

#### US-2.2 Python Worker 集成 (架构重构)
**作为** 后端开发者
**我想要** 创建一个稳定的 Python Worker 服务
**以便** 在 Windows 环境下稳定运行 AI 模型

**验收标准**:
- [x] Python Worker 支持 Server 模式（常驻进程）
- [x] Node.js 和 Python 通过 STDIN/STDOUT 通信
- [x] 模型单例加载，避免重复初始化
- [x] 解决 Windows CUDA 多进程崩溃问题

**任务拆解**:
- [x] Task-2.2.1: 创建 Python Worker 脚本（3h）
- [x] Task-2.2.2: 实现 Server 模式与 JSON 通信协议（3h） - **[Changed]**
- [x] Task-2.2.3: QueueService 集成持久化 Worker 管理（4h） - **[Changed]**
- [x] Task-2.2.4: 实现环境变量配置 (WHISPER_DEVICE, COMPUTE_TYPE)（1h） - **[New]**
- [x] Task-2.2.5: 添加音频文件诊断备份机制（1h） - **[New]**

---

#### US-2.3 faster-whisper 转写服务
**作为** 用户
**我想要** 将音频转换为文字
**以便** 查看和编辑内容

**验收标准**:
- [x] 转写准确率 ≥95%
- [x] 返回带时间戳的分段文本
- [x] 支持中英文自动检测
- [x] 处理速度 ≥10x 实时速度

**任务拆解**:
- [x] Task-2.3.1: 在 Python Worker 中加载 Whisper 模型（2h）
- [x] Task-2.3.2: 实现转写逻辑（4h）
- [x] Task-2.3.3: 实现进度报告（2h）
- [x] Task-2.3.4: 优化 GPU 使用（默认 float16）（2h）
- [x] Task-2.3.5: 语言自动检测（1h）
- [x] Task-2.3.6: 测试和性能调优（3h）

---

#### US-2.4 转写 API 端点与轮询优化
**作为** 前端开发者
**我想要** 调用转写 API 并获取实时状态
**以便** 启动转写任务并展示进度

**验收标准**:
- [x] POST /api/projects/:id/transcribe 接口
- [x] 智能轮询策略生效，减少无效请求
- [x] API 返回包含 duration 字段

**任务拆解**:
- [x] Task-2.4.1: 实现转写 API 接口（3h）
- [x] Task-2.4.2: 创建任务队列（4h）
- [x] Task-2.4.3: 实现任务处理流程（4h）
- [x] Task-2.4.4: 后端 API 返回 duration 字段（30min） - **[New]**
- [x] Task-2.4.5: 前端实现基于预估时间的智能轮询策略（2h） - **[New]**

---

#### US-2.5 转写结果查询 API
**作为** 前端开发者
**我想要** 查询转写结果
**以便** 在界面上显示

**验收标准**:
- [x] GET /api/projects/:id/transcription
- [x] 返回分段文本和时间戳
- [x] 支持进度查询

**任务拆解**:
- [x] Task-2.5.1: 实现获取转写结果接口（2h）
- [x] Task-2.5.2: 实现转写进度查询接口（2h）
- [x] Task-2.5.3: 数据格式化（1h）
- [x] Task-2.5.4: 添加缓存机制（2h）

---

**Sprint 2 总结**:
- **总估时**: 约 60-65 小时
- **关键交付物**:
  - ✅ 音频提取功能 (ffmpeg + ffprobe)
  - ✅ Python Worker (Persistent Server Mode)
  - ✅ 转写功能完整可用
  - ✅ 智能轮询机制
  - ✅ 稳定性修复 (解决 Windows CUDA 崩溃)

---
