# 妙记 MVP 开发任务清单

## 项目概览

**项目目标**: 完成可用的 MVP 版本，实现音视频转写和 AI 总结的核心功能

**开发周期**: 8-10 周（5 个 Sprint）

**团队规模**: 1-2 人

**技术栈**: Windows 后端 (Node.js + Python) + Web 前端 (React)

---

## Sprint 2: AI 处理核心功能（Week 5-6）

### 目标
集成 faster-whisper 和 FFmpeg，实现音频提取和转写功能，并优化任务状态管理。

### User Stories

#### US-2.0 任务状态管理优化
**作为** 开发者
**我想要** 一个健壮的任务状态机
**以便** 精确跟踪处理进度并支持断点重试

**验收标准**:
- [ ] 数据库支持细粒度状态（uploaded, extracting, transcribing...）
- [ ] QueueService 支持基于状态的分步处理
- [ ] 失败任务记录具体的 failed_stage
- [ ] 支持从失败阶段重试

**任务拆解**:
- [ ] Task-2.0.1: 数据库 Schema 迁移（添加状态字段和错误信息）（1h）
- [ ] Task-2.0.2: 重构 QueueService 为状态机模式（3h）
- [ ] Task-2.0.3: 实现失败重试接口（1h）

---

#### US-2.1 FFmpeg 音频提取服务
**作为** 系统
**我想要** 从视频中提取音频
**以便** 进行语音识别

**验收标准**:
- [ ] 支持多种视频格式
- [ ] 输出 16kHz 单声道 WAV
- [ ] 提取进度可追踪
- [ ] 错误处理完善

**任务拆解**:
- [ ] Task-2.1.1: 安装 fluent-ffmpeg（30min）
  ```bash
  npm install fluent-ffmpeg @types/fluent-ffmpeg
  ```
- [ ] Task-2.1.2: 创建 AudioExtractor 服务类（3h）
  ```typescript
  class AudioExtractor {
    async extract(videoPath: string): Promise<string>
  }
  ```
- [ ] Task-2.1.3: 实现进度回调（2h）
- [ ] Task-2.1.4: 添加错误处理和重试逻辑（2h）
- [ ] Task-2.1.5: 测试不同格式视频（2h）
- [ ] Task-2.1.6: 性能优化（1h）

---

#### US-2.2 Python Worker 集成
**作为** 后端开发者
**我想要** 创建 Python Worker 进程
**以便** 运行 AI 模型

**验收标准**:
- [ ] Python Worker 可以启动和停止
- [ ] Node.js 和 Python 通信正常
- [ ] 错误处理和进程管理完善

**任务拆解**:
- [ ] Task-2.2.1: 创建 Python Worker 脚本（3h）
  ```python
  # server/python/asr_worker.py
  import sys
  import json
  from faster_whisper import WhisperModel
  ```
- [ ] Task-2.2.2: 实现 stdin/stdout 通信（2h）
- [ ] Task-2.2.3: 创建 WorkerManager 类（4h）
  ```typescript
  class WorkerManager {
    startWorker()
    stopWorker()
    sendTask()
  }
  ```
- [ ] Task-2.2.4: 实现进程池管理（3h）
  - 支持多个 Worker 实例
  - 负载均衡
- [ ] Task-2.2.5: 添加进程健康检查（2h）
- [ ] Task-2.2.6: 错误恢复机制（2h）

---

#### US-2.3 faster-whisper 转写服务
**作为** 用户
**我想要** 将音频转换为文字
**以便** 查看和编辑内容

**验收标准**:
- [ ] 转写准确率 ≥95%
- [ ] 返回带时间戳的分段文本
- [ ] 支持中英文自动检测
- [ ] 处理速度 ≥10x 实时速度

**任务拆解**:
- [ ] Task-2.3.1: 在 Python Worker 中加载 Whisper 模型（2h）
  ```python
  model = WhisperModel("large-v3", device="cuda")
  ```
- [ ] Task-2.3.2: 实现转写逻辑（4h）
  - VAD（语音活动检测）
  - 分段处理
  - 时间戳生成
- [ ] Task-2.3.3: 实现进度报告（2h）
- [ ] Task-2.3.4: 优化 GPU 使用（2h）
  - 批处理
  - 混合精度推理
- [ ] Task-2.3.5: 语言自动检测（1h）
- [ ] Task-2.3.6: 测试和性能调优（3h）

---

#### US-2.4 转写 API 端点
**作为** 前端开发者
**我想要** 调用转写 API
**以便** 启动转写任务

**验收标准**:
- [ ] POST /api/projects/:id/transcribe 接口
- [ ] 返回任务 ID
- [ ] 支持异步处理

**任务拆解**:
- [ ] Task-2.4.1: 实现转写 API 接口（3h）
- [ ] Task-2.4.2: 创建任务队列（4h）
  - 使用 Bull 或自己实现
  - 任务状态管理
- [ ] Task-2.4.3: 实现任务处理流程（4h）
  ```typescript
  async function processTranscription(projectId) {
    // 1. 提取音频
    // 2. 调用 Python Worker
    // 3. 保存结果
  }
  ```
- [ ] Task-2.4.4: 添加任务取消功能（2h）
- [ ] Task-2.4.5: 错误处理和重试（2h）

---

#### US-2.5 转写结果查询 API
**作为** 前端开发者
**我想要** 查询转写结果
**以便** 在界面上显示

**验收标准**:
- [ ] GET /api/projects/:id/transcription
- [ ] 返回分段文本和时间戳
- [ ] 支持进度查询

**任务拆解**:
- [ ] Task-2.5.1: 实现获取转写结果接口（2h）
- [ ] Task-2.5.2: 实现转写进度查询接口（2h）
  - GET /api/projects/:id/status
- [ ] Task-2.5.3: 数据格式化（1h）
  ```json
  {
    "segments": [
      {"id": "1", "start": 0, "end": 5, "text": "..."}
    ]
  }
  ```
- [ ] Task-2.5.4: 添加缓存机制（2h）

---

**Sprint 2 总结**:
- **总估时**: 约 55-60 小时
- **关键交付物**:
  - ✅ 音频提取功能
  - ✅ Python Worker 集成
  - ✅ 转写功能完整可用

---
