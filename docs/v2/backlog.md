# Backlog: 非功能性需求与未来功能

### 目标
收集非功能性需求和未来计划的功能，按优先级排序。

### User Stories

#### US-6.5 版本管理与回溯
**作为** 用户/运营
**我想要** 管理不同阶段的转写版本
**以便** 在润色和人工修改过程中随时回滚、对比、导出

**验收标准**:
- [ ] 系统内置三个阶段：V0（原始 Faster-Whisper 输出）、V1（AI 润色版）、Active Version（用户当前编辑中版本）
- [ ] 每次自动保存更新 Active Version
- [ ] 用户可以将当前 Active Version 另存为新版本（V2、V3 ...），也可以加载历史版本成为 Active Version
- [ ] 用户可以删除历史版本，但 **不得删除 V0/V1**
- [ ] 导出始终基于当前 Active Version

**任务拆解**:
- [ ] Task-6.5.1: 设计版本数据模型（版本表、关联转写内容、元数据）（4h）
- [ ] Task-6.5.2: 实现版本创建/读取/切换/删除 API（5h）
- [ ] Task-6.5.3: 前端版本管理面板（版本列表、另存、新建、删除、加载）（6h）
- [ ] Task-6.5.4: 自动保存与版本 API 联动，确保 Active Version 一致性（3h）
- [ ] Task-6.5.5: 导出逻辑切换为基于 Active Version 内容（1h）

#### US-7.1 多语言转写支持
**作为** 用户
**我想要** 在转写时选择目标语言
**以便** 准确转写不同语言的音频内容

**验收标准**:
- [ ] 上传文件时，前端显示语言选择界面（支持中文、英文、日语等常见语言）
- [ ] 语言选择信息随文件上传请求传递到后端
- [ ] 后端将目标语言参数传递给转写引擎（Faster-Whisper）
- [ ] 转写结果能够正确识别并转写所选语言的内容
- [ ] 数据库存储目标语言信息，便于后续查询和管理

**任务拆解**:
- [ ] Task-7.1.1: 设计语言选择 UI（下拉菜单或按钮组），包含常见语言选项（中文、英文、日语、韩语、法语、德语、西班牙语等）（2h）
- [ ] Task-7.1.2: 修改上传 API，接收并存储目标语言参数（`target_language`）（2h）
- [ ] Task-7.1.3: 修改数据库 schema，在 `media_files` 表中添加 `target_language` 字段（1h）
- [ ] Task-7.1.4: 修改队列处理逻辑，将目标语言传递给 Python Worker（2h）
- [ ] Task-7.1.5: 修改 Python Worker，支持指定语言参数调用 Faster-Whisper（3h）
- [ ] Task-7.1.6: 测试各种语言的转写准确性（3h）

---

#### US-7.2 非中文内容自动翻译
**作为** 用户
**我想要** 转写非中文内容时自动获得中文翻译
**以便** 快速理解外语内容，无需手动翻译

**验收标准**:
- [ ] 当目标语言为非中文时，在转写完成后自动触发翻译流程
- [ ] 翻译使用 Ollama（或指定 LLM）进行全文翻译
- [ ] 翻译结果保存为独立字段，与原始转写内容分离
- [ ] 前端可以切换显示原始转写内容或翻译内容
- [ ] 翻译失败时给出错误提示，但不影响原始转写结果的显示

**任务拆解**:
- [ ] Task-7.2.1: 设计翻译 Prompt 模板，确保翻译准确性和格式一致性（2h）
- [ ] Task-7.2.2: 修改队列处理逻辑，在转写完成后检测目标语言，非中文时触发翻译（3h）
- [ ] Task-7.2.3: 实现翻译服务接口，调用 Ollama 进行全文翻译（4h）
- [ ] Task-7.2.4: 修改数据库 schema，在 `transcriptions` 表中添加 `translated_content` 字段（2h）
- [ ] Task-7.2.5: 修改前端 TranscriptionResult 组件，支持切换显示原始/翻译内容（4h）
- [ ] Task-7.2.6: 处理翻译失败场景，提供重试机制（2h）
- [ ] Task-7.2.7: 优化翻译性能，支持长文本分段翻译（3h）

---

#### US-Last.1 错误处理与诊断优化
**作为** 系统管理员
**我想要** 系统能自我诊断并提供详细日志
**以便** 快速定位问题

**验收标准**:
- [ ] 所有错误都有提示
- [ ] 诊断文件（diagnostics）有清理机制

**任务拆解**:
- [ ] Task-5.3.1: 统一错误代码（2h）
- [ ] Task-5.3.2: 实现 Toast 提示组件（2h）
- [ ] Task-5.3.3: 实现诊断文件自动清理（Cron Job）（2h） - **[New]**
  - 清理 `server/diagnostics` 目录下超过 7 天的文件
- [ ] Task-5.3.4: 完善各接口错误处理（3h）

---

#### US-Last.2 性能优化
**作为** 开发者
**我想要** 优化应用性能
**以便** 提供更好的用户体验

**验收标准**:
- [ ] 前端加载时间 < 2s
- [ ] API 响应时间 < 100ms
- [ ] GPU 利用率 > 80%

**任务拆解**:
- [ ] Task-5.4.1: 前端代码分割（2h）
- [ ] Task-5.4.2: 图片和资源优化（1h）
- [ ] Task-5.4.3: API 响应缓存（2h）
- [ ] Task-5.4.4: 数据库查询优化（2h）
- [ ] Task-5.4.5: GPU 显存监控与自动释放（3h） - **[Updated]**
  - 监控 Python Worker 显存占用

---

#### US-Last.3 部署配置
**作为** 开发者
**我想要** 在生产环境部署应用
**以便** 实际使用

**验收标准**:
- [ ] PM2 配置完成
- [ ] 可以开机自启动
- [ ] 日志正常记录

**任务拆解**:
- [ ] Task-5.5.1: 创建 ecosystem.config.js（1h）
- [ ] Task-5.5.2: 配置环境变量（1h）
- [ ] Task-5.5.3: 编写启动脚本（1h）
- [ ] Task-5.5.4: 配置 PM2 开机自启（1h）
- [ ] Task-5.5.5: 配置 Windows 防火墙（30min）
- [ ] Task-5.5.6: 编写部署文档（2h）

---

#### US-Last.4 测试与文档
**作为** 开发者
**我想要** 完整的测试和文档
**以便** 保证质量和可维护性

**验收标准**:
- [ ] 核心功能有单元测试
- [ ] API 文档完整
- [ ] 用户手册完成

**任务拆解**:
- [ ] Task-5.6.1: 编写后端单元测试（4h）
- [ ] Task-5.6.2: 编写前端组件测试（4h）
- [ ] Task-5.6.3: 编写 API 文档（2h）
- [ ] Task-5.6.4: 编写用户手册（3h）
- [ ] Task-5.6.5: 编写开发者文档（2h）

---

#### US-Last.5 安全加固
**作为** 开发者
**我想要** 增强系统的安全性
**以便** 防止未授权访问和恶意攻击

**验收标准**:
- [ ] CORS 策略仅限受信任的来源
- [ ] 增加 API 速率限制 (Rate Limiting)
- [ ] 上传文件类型和大小的严格后端校验
- [ ] (可选) 简单的 API Token 认证机制

**任务拆解**:
- [ ] Task-5.7.1: 配置严格的 CORS 规则（允许 localhost 和局域网 IP 段）
- [ ] Task-5.7.2: 集成 @fastify/rate-limit 防止暴力请求
- [ ] Task-5.7.3: 完善文件上传的安全校验（Magic Number 检查文件头）
- [ ] Task-5.7.4: 实现简单的 Authorization Header 校验（如果在非家庭环境使用）

---

#### US-Last.6 高级文件管理
**作为** 用户/系统管理员
**我想要** 更智能的文件存储策略
**以便** 节省空间并防止误删

**验收标准**:
- [ ] 重复文件上传时实现秒传（基于 Hash）
- [ ] 支持手动锁定文件（防止自动清理）
- [ ] 过期且未锁定文件自动清理
- [ ] 存储目录按日期分层（YYYY/MM/DD）

**任务拆解**:
- [ ] Task-5.8.1: 实现文件 SHA-256 计算与查重逻辑（2h）
  - 后端计算 Hash，如果存在则复用
- [ ] Task-5.8.2: 数据库迁移（1h）
  - 添加 `file_hash`, `is_locked` (default false), `expire_at` 字段
- [ ] Task-5.8.3: 实现文件锁定/解锁 API 及前端交互（2h）
  - `POST /api/projects/:id/lock`
- [ ] Task-5.8.4: 实现 Cron Job 定时清理过期文件（2h）
  - 每天凌晨运行，清理 `expire_at < now` AND `is_locked = false` 的物理文件
- [ ] Task-5.8.5: 优化上传存储路径逻辑（1h）
  - 使用 `uploads/YYYY/MM/DD/` 结构

---

### Backlog 总结
- **总估时**: 约 88-92 小时
  - US-6.5: 19h
  - US-Last.1: 9h
  - US-Last.2: 10h
  - US-Last.3: 6.5h
  - US-Last.4: 15h
  - US-Last.5: 8h
  - US-Last.6: 11h
- **关键交付物**:
  - ⏳ 版本管理与回溯机制
  - ⏳ 错误处理与诊断能力
  - ⏳ 性能调优（前端/后端）
  - ⏳ 部署与运行维护工具链
  - ⏳ 测试与文档体系
  - ⏳ 安全加固与文件治理

