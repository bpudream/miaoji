# Sprint 6: 多媒体联动与沉浸式稿面（Week 13-14）

### 目标
重构项目详情页布局，引入播放器面板，并实现段落与音/视频的联动播放体验。

### User Stories

#### US-6.1 多面板布局与分区滚动
**作为** 产品使用者
**我想要** 同时查看播放器、总结和转写内容
**以便** 在一个视图中快速理解与校对稿件

**验收标准**:
- [ ] 项目详情页改为「左 60% / 右 40%」的双栏布局
- [ ] 左侧再拆为上下两块（顶部播放器、底部 AI 总结）
- [ ] 各面板高度固定、支持独立滚动，不出现整页滚动条

**任务拆解**:
- [ ] Task-6.1.1: 重构 ProjectDetail 布局为自适应 Grid（6h）
- [ ] Task-6.1.2: 将播放面板与总结面板拆分为可复用组件（3h）
- [ ] Task-6.1.3: 为各面板添加固定高度与内部滚动（3h）
- [ ] Task-6.1.4: 处理响应式断点与大屏/小屏降级策略（2h）

---

#### US-6.2 播放器接入与段落联动
**作为** 用户
**我想要** 在网页中播放原音/视频并与转写段落联动
**以便** 快速核对内容并跳转到对应时间点

**验收标准**:
- [x] 内置音/视频播放控件，支持本地文件
- [x] 点击转写段落可跳转至对应的播放时间
- [x] 播放器状态可回写到段落（高亮当前段、显示播放进度）
- [x] 支持无视频输入时的纯音频模式

**任务拆解**:
- [x] Task-6.2.1: 集成视频/音频播放器组件与本地源加载（4h）(完成时间：2025-11-21)
- [x] Task-6.2.2: 建立段落时间戳到播放器的 seek 同步（6h）(完成时间：2025-11-21)
- [x] Task-6.2.3: 实现播放器 -> 段落的激活高亮与自动滚动（4h）(完成时间：2025-11-21)
- [x] Task-6.2.4: 设计播放控制面板（倍速、静音、循环）（3h）(完成时间：2025-11-21)
- [x] Task-6.2.5: 提供音频 fallback UI（2h）(完成时间：2025-11-21)

---

#### US-6.3 AI 面板增强（可选）
**作为** 用户
**我想要** 在观看/校对时获得更丰富的 AI 辅助信息
**以便** 迅速抓住重点并复用内容

**验收标准**:
- [ ] AI 总结面板支持多 Tab（概览/要点/行动项）
- [ ] 与播放器联动，可根据播放进度突出相关段落

**任务拆解**:
- [ ] Task-6.3.1: 重构 SummaryPanel 为多 Tab 结构（3h）
- [ ] Task-6.3.2: 替换为固定高度 + 内部滚动（1h）
- [ ] Task-6.3.3: 与播放器/段落的事件总线集成（4h）
- [ ] Task-6.3.4: 支持未来的评论/标记占位（2h）

---

#### US-6.4 转写润色与后处理
**作为** 用户/运营
**我想要** 在完成转写后获得可读性更强、带标点的稿件
**以便** 直接复用到文案、报告或字幕中

**验收标准**:
- [ ] 支持手动触发“润色”流程
- [ ] 使用 Ollama（或指定 LLM）对原始转写内容进行纠错、补充标点和段落
- [ ] 生成润色后的版本并保存（可回溯）
- [ ] UI 中可查看原文/润色稿的差异，避免误改

**任务拆解**:
- [ ] Task-6.4.1: 设计润色 Prompt 与输出模板（3h）
- [ ] Task-6.4.2: 在后端集成润色接口，调用 Ollama 对全文批处理（6h）
- [ ] Task-6.4.3: 建立润色结果的存储结构（含原文/润色版、时间戳）（4h）
- [ ] Task-6.4.4: 前端提供“润色”按钮与结果展示、对比 UI（6h）
- [ ] Task-6.4.5: 若润色失败，给出错误提示与重试入口（1h）

---

#### US-6.5 版本管理与回溯
**作为** 用户/运营
**我想要** 管理不同阶段的转写版本
**以便** 在润色和人工修改过程中随时回滚、对比、导出

**验收标准**:
- [ ] 系统内置三个阶段：V0（原始 Faster-Whisper 输出）、V1（AI 润色版）、Active Version（用户当前编辑中版本）
- [ ] 每次自动保存更新 Active Version
- [ ] 用户可以将当前 Active Version 另存为新版本（V2、V3 ...），也可以加载历史版本成为 Active Version
- [ ] 用户可以删除历史版本，但 **不得删除 V0/V1**
- [ ] 导出始终基于当前 Active Version

**任务拆解**:
- [ ] Task-6.5.1: 设计版本数据模型（版本表、关联转写内容、元数据）（4h）
- [ ] Task-6.5.2: 实现版本创建/读取/切换/删除 API（5h）
- [ ] Task-6.5.3: 前端版本管理面板（版本列表、另存、新建、删除、加载）（6h）
- [ ] Task-6.5.4: 自动保存与版本 API 联动，确保 Active Version 一致性（3h）
- [ ] Task-6.5.5: 导出逻辑切换为基于 Active Version 内容（1h）

---

#### US-6.6 页面布局优化与滚动控制
**作为** 用户
**我想要** 页面无主滚动条，所有内容在固定面板内滚动
**以便** 获得更沉浸的编辑体验，最大化文本内容显示空间

**验收标准**:
- [ ] 消除页面级滚动条，所有滚动限制在各面板内部
- [ ] 转写内容标题栏整合所有操作按钮（编辑、润色、版本、导出），节省纵向空间
- [ ] 确保各面板高度计算正确，无内容溢出

**任务拆解**:
- [ ] Task-6.6.1: 修复页面级滚动条问题，确保各面板独立滚动（2h）
- [ ] Task-6.6.2: 将编辑/润色/版本/导出按钮整合到转写标题栏（2h）
- [ ] Task-6.6.3: 优化面板高度计算与响应式布局（1h）

---

#### US-6.7 播放器模式切换与空间优化
**作为** 用户
**我想要** 根据媒体类型自动调整播放器模式，并优化空间分配
**以便** 在音频模式下为AI总结留出更多空间，在视频模式下优先显示视频

**验收标准**:
- [x] 根据文件类型（音频/视频）自动判断播放模式
- [x] 音频文件仅显示音频播放器，视频文件默认音频模式但可切换为视频
- [x] 音频模式下播放器高度较小，为AI总结留出更多空间
- [x] 视频模式下优先保证视频显示高度，AI总结区域可压缩
- [x] 切换播放模式时保持播放状态（播放时间、播放/暂停状态）无缝同步

**任务拆解**:
- [x] Task-6.7.1: 实现文件类型检测与播放模式判断（2h）(完成时间：2024-12-XX)
- [x] Task-6.7.2: 实现音频/视频模式切换UI与逻辑（3h）(完成时间：2024-12-XX)
  - [x] 子任务：修复播放模式切换时播放状态维持问题（稳定DOM结构，优化状态同步逻辑）
- [x] Task-6.7.3: 根据播放模式动态调整面板高度分配（3h）(完成时间：2024-12-XX)

---

#### US-6.8 转写内容标题栏整合优化
**作为** 用户
**我想要** 所有转写相关操作集中在标题栏
**以便** 节省纵向空间，最大化文本内容显示区域

**验收标准**:
- [ ] 编辑、润色、版本、导出按钮统一放在转写内容标题栏
- [ ] 复制按钮保留在标题栏
- [ ] 移除独立的操作按钮行，节省纵向空间

**任务拆解**:
- [ ] Task-6.8.1: 重构 TranscriptionResult 组件，将操作按钮移至标题栏（2h）
- [ ] Task-6.8.2: 优化按钮布局与视觉层次（1h）

---

#### US-6.9 系统状态页面
**作为** 用户
**我想要** 在系统设置中查看服务器访问信息
**以便** 快速获取访问链接，方便在其他设备上访问系统

**验收标准**:
- [ ] 在系统设置页面中新增"系统状态"区域
- [ ] 显示当前服务器 IP 地址（前端和后端）
- [ ] 显示完整的访问链接（前端链接），支持一键复制
- [ ] 支持生成二维码，方便手机扫码访问
- [ ] 显示后端 API 地址（供开发者参考）

**任务拆解**:
- [ ] Task-6.9.1: 后端实现获取服务器 IP 地址和端口信息的 API（2h）
- [ ] Task-6.9.2: 前端实现系统状态页面 UI，显示 IP 和链接（3h）
- [ ] Task-6.9.3: 集成二维码生成库，实现扫码功能（2h）
- [ ] Task-6.9.4: 实现链接复制功能（1h）

---

#### US-6.10 多存储路径管理
**作为** 用户
**我想要** 配置多个存储路径用于保存上传的音视频文件
**以便** 当默认路径磁盘空间不足时，可以扩展存储空间，或使用多个磁盘分散存储

**验收标准**:
- [x] 在系统设置中可以添加、编辑、删除存储路径
- [x] 支持配置多个存储路径，系统自动选择可用空间最大的路径
- [x] 显示每个路径的磁盘使用情况（总容量、已用空间、可用空间）
- [x] 支持将已有文件迁移到新的存储路径
- [x] 支持批量迁移功能（选择多个文件或按条件筛选）
- [x] 迁移过程中显示进度
- [x] 新上传的文件自动使用可用空间最大的路径

**任务拆解**:

##### Task-6.10.1: 数据库扩展 - 存储路径配置表
- [x] **文件**: `server/src/db.ts` (完成时间：2024-12-XX)
- [x] **新增表**: `storage_paths`
  ```sql
  CREATE TABLE IF NOT EXISTS storage_paths (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,              -- 路径名称（用户自定义，如"D盘"、"外置硬盘"）
    path TEXT NOT NULL UNIQUE,       -- 存储路径（绝对路径）
    enabled BOOLEAN DEFAULT 1,       -- 是否启用
    priority INTEGER DEFAULT 0,       -- 优先级（数字越大优先级越高，用于路径选择）
    max_size_gb INTEGER,             -- 最大容量限制（GB，可选，NULL表示无限制）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );
  ```
- [x] **迁移逻辑**:
  - 在initDb中添加表创建
  - 如果表为空，插入默认路径（当前 `../uploads`）
- [x] **索引**: 为 `enabled` 和 `priority` 创建索引以优化查询

##### Task-6.10.2: 存储路径管理服务 - 路径选择逻辑
- [x] **文件**: `server/src/services/storage.ts` (完成时间：2024-12-XX)
- [x] **功能**: 创建 `StorageService` 类
- [x] **核心方法**:
  - `getBestStoragePath()`: 选择最佳存储路径
    - 查询所有启用的路径
    - 计算每个路径的可用空间（使用 `fs.statfs` 或 `df` 命令）
    - 按可用空间降序排序，选择最大的
    - 如果设置了 `max_size_gb`，检查是否超限
    - 如果所有路径都不可用，抛出错误
  - `getStorageInfo(path: string)`: 获取路径的磁盘信息
    - 总容量、已用空间、可用空间
    - 使用百分比
  - `getAllStorageInfo()`: 获取所有路径的磁盘信息
- [x] **依赖**: 使用跨平台的磁盘信息获取方法（Windows/Linux/macOS）

##### Task-6.10.3: 存储路径管理 API
- [x] **文件**: `server/src/app.ts` (完成时间：2024-12-XX)
- [x] **端点**:
  - `GET /api/storage/paths`: 获取所有存储路径列表（含磁盘信息）
  - `POST /api/storage/paths`: 添加新存储路径
    - 请求体: `{ name: string, path: string, priority?: number, max_size_gb?: number }`
    - 验证路径是否存在、可写
    - 检查路径是否已存在
  - `PUT /api/storage/paths/:id`: 更新存储路径
    - 请求体: `{ name?: string, enabled?: boolean, priority?: number, max_size_gb?: number }`
  - `DELETE /api/storage/paths/:id`: 删除存储路径
    - 检查是否有文件使用该路径
    - 如果有文件，不允许删除（或提供迁移选项）
  - `GET /api/storage/paths/:id/info`: 获取指定路径的磁盘信息
- [x] **验证**: 路径必须是绝对路径，且目录存在、可写

##### Task-6.10.4: 文件迁移服务 - 单文件迁移
- [x] **文件**: `server/src/services/storage.ts` (完成时间：2024-12-XX)
- [x] **功能**: 实现 `migrateFile` 方法
- [x] **流程**:
  1. 验证源文件存在
  2. 验证目标路径可用（存在、可写、有足够空间）
  3. 复制文件到目标路径（使用 `fs.copyFile`）
  4. 更新数据库中的 `filepath` 字段
  5. 如果 `audio_path` 也在同一目录，一并迁移
  6. 删除源文件（可选，默认保留作为备份）
  7. 返回迁移结果
- [x] **错误处理**:
  - 文件不存在
  - 目标路径不可用
  - 磁盘空间不足
  - 复制失败
- [x] **事务**: 确保数据库更新和文件操作的一致性

##### Task-6.10.5: 文件迁移服务 - 批量迁移
- [x] **文件**: `server/src/services/storage.ts` (完成时间：2024-12-XX)
- [x] **功能**: 实现 `migrateFiles` 方法
- [x] **流程**:
  1. 接收文件ID数组或筛选条件
  2. 验证所有文件存在
  3. 逐个迁移（串行或并行，建议串行避免IO过载）
  4. 记录每个文件的迁移状态（成功/失败/跳过）
  5. 返回迁移报告
- [x] **进度回调**: 支持进度回调，用于前端显示
- [ ] **取消支持**: 支持取消正在进行的批量迁移（待实现）
- [x] **API端点**: `POST /api/storage/migrate`
  - 请求体: `{ file_ids: number[], target_path_id: number, delete_source?: boolean }`
  - 响应: 返回迁移结果报告

##### Task-6.10.6: 修改上传逻辑 - 使用路径选择服务
- [x] **文件**: `server/src/app.ts` (完成时间：2024-12-XX)
- [x] **修改**: `POST /api/upload` 端点
- [x] **逻辑**:
  - 不再使用硬编码的 `UPLOAD_DIR`
  - 调用 `StorageService.getBestStoragePath()` 获取最佳路径
  - 如果获取失败，使用默认路径（向后兼容）
  - 文件保存到选择的路径
  - 数据库中的 `filepath` 存储完整绝对路径
- [x] **向后兼容**: 如果 `storage_paths` 表为空，使用默认路径

##### Task-6.10.7: 前端 - 存储路径管理 UI
- [x] **文件**: `web/src/components/StoragePathsManager.tsx` (完成时间：2024-12-XX)
- [x] **功能**: 在设置页面新增"存储路径管理"区域
- [x] **UI组件**:
  - 路径列表表格：
    - 显示：名称、路径、状态（启用/禁用）、优先级、磁盘信息（总容量/已用/可用/使用率）
    - 操作：编辑、删除、启用/禁用
  - 添加路径表单：
    - 路径名称（输入框）
    - 存储路径（输入框 + 路径验证）
    - 优先级（数字输入，默认0）
    - 最大容量限制（可选，数字输入，单位GB）
  - 磁盘信息卡片：
    - 显示每个路径的磁盘使用情况
    - 使用进度条可视化
    - 显示可用空间警告（<10%时显示警告）
- [x] **交互**:
  - 添加路径时验证路径有效性
  - 删除路径前检查是否有文件使用
  - 支持编辑和更新路径配置

##### Task-6.10.8: 前端 - 文件迁移 UI
- [x] **文件**: `web/src/components/FileMigrationDialog.tsx` (完成时间：2024-12-XX)
- [x] **功能**: 文件迁移对话框/页面
- [x] **UI组件**:
  - 源路径选择（显示当前文件所在路径）
  - 目标路径选择（下拉列表，显示所有可用路径及磁盘信息）
  - 文件列表（显示要迁移的文件，支持多选）
  - 迁移选项：
    - 迁移后删除源文件（复选框）
  - 进度显示：
    - 总体进度条
    - 当前迁移文件
    - 成功/失败统计
  - 操作按钮：开始迁移、关闭对话框
- [x] **集成位置**:
  - 在项目列表页：支持批量选择文件迁移（通过 ProjectActionDialog）
  - 在项目详情页：支持单个文件迁移
  - 在存储路径管理页：支持迁移该路径下的所有文件

---

### Sprint 6 总结
- **总估时**: 约 91-99 小时（新增 27 小时）
- **关键交付物**:
  - ✅ 多面板布局与沉浸式稿面
  - ✅ 浏览器内播放控件与段落跳转
  - ✅ 面板级滚动与响应式体验
  - ✅ 转写润色与后处理能力
  - ✅ 版本管理与回溯机制
  - ✅ 页面滚动控制与空间优化
  - ✅ 播放器模式切换与动态布局
  - ✅ 系统状态页面与访问链接管理
  - ✅ 多存储路径管理与文件迁移功能

