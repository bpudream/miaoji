# Sprint 07: 长文本智能切片总结优化 (Chunked Summary Enhancement)

**Sprint 目标**：
解决14B模型在处理长视频时总结质量差的问题。通过实现"智能切片 -> 分段提取 -> 全局聚合"的Map-Reduce流程，将长文本切分为2k-4k token的片段，分别提取关键信息后再汇总，显著提升长视频总结的信息密度和准确性。

**周期**：2024-12-XX ~ 2024-12-XX
**状态**：待开始 (Pending)

---

## User Stories

### US-7.1 智能切片功能 (Smart Chunking)
**作为** 系统
**我想要** 根据Whisper时间戳和文本长度，在自然断句点（长停顿、句号）处智能切分文本
**以便** 每个切片保持在2k-4k token范围内，且不会打断逻辑连贯性，切片间保留10-15%重叠。

**验收标准**:
- [ ] 长文本（>5000 token）被正确切分为多个2k-4k token的chunks
- [ ] 切片边界在自然断句点（长停顿或句号），不会切断句子
- [ ] 相邻chunks有10-15%的重叠内容
- [ ] 切片处理时间 < 1秒（纯计算，无AI调用）

**任务拆解**:
- [ ] Task-7.1.1: 创建切片工具模块 `server/src/services/chunking.ts`，实现 `smartSplitSegments` 函数（估时：6h）
- [ ] Task-7.1.2: 实现或优化 `estimateTokens` 函数，支持中英文混合文本（估时：2h）
- [ ] Task-7.1.3: 编写单元测试 `server/tests/chunking.test.ts`（估时：3h）

---

### US-7.2 分段提取功能 (Extract Phase)
**作为** 系统
**我想要** 对每个切片进行结构化信息提取（而非简单总结）
**以便** 能够保留高密度的关键信息点（决策点、待办事项、争议点等），避免信息在"传话游戏"中衰减。

**验收标准**:
- [ ] 每个chunk提取出结构化的信息点（而非通顺短文）
- [ ] 信息点包含关键细节（决策、待办、数据等）
- [ ] 不同场景类型使用对应的提取策略（会议/销售/教育/通用）
- [ ] 单个chunk提取时间 < 30秒（取决于模型速度）

**任务拆解**:
- [ ] Task-7.2.1: 扩展OllamaService支持提取模式，新增 `getExtractPrompt` 方法（估时：4h）
- [ ] Task-7.2.2: 创建分段处理服务 `server/src/services/chunkProcessor.ts`，实现 `processChunkExtraction` 方法（估时：5h）
- [ ] Task-7.2.3: 数据库扩展 - 创建 `summary_chunks` 表存储切片和提取结果（估时：3h）

---

### US-7.3 全局聚合功能 (Aggregate & Generate Phase)
**作为** 系统
**我想要** 将所有切片提取的信息点合并，再生成最终总结
**以便** 模型能够基于高密度干货建立全局关联，生成更准确、更完整的总结。

**验收标准**:
- [ ] 最终总结基于所有信息点生成
- [ ] 总结信息密度高，细节保留完整
- [ ] 总结建立了全局关联，逻辑连贯
- [ ] 聚合生成时间 < 60秒
- [ ] 短文本（<2000 token）仍使用原有直接总结流程（向后兼容）

**任务拆解**:
- [ ] Task-7.3.1: 实现聚合与生成服务，在 `chunkProcessor.ts` 中实现 `aggregateAndGenerate` 方法（估时：5h）
- [ ] Task-7.3.2: 重构总结API端点 `POST /api/projects/:id/summarize`，支持切片流程（估时：6h）
- [ ] Task-7.3.3: 新增切片状态查询API `GET /api/projects/:id/summary/chunks`（估时：2h）

---

### US-7.4 切片总结配置与监控
**作为** 用户
**我想要** 能够配置切片参数（目标token数、重叠比例、停顿阈值），并查看切片处理进度
**以便** 我可以根据视频类型（会议/销售/教育）调整策略，并了解处理状态。

**验收标准**:
- [ ] 用户可以看到切片处理进度
- [ ] 用户可以配置切片参数（目标token数、重叠比例、场景类型、停顿阈值）
- [ ] 显示每个chunk的状态（pending/processing/completed/failed）
- [ ] 错误信息清晰，失败chunk可重试

**任务拆解**:
- [ ] Task-7.4.1: 前端 - 在设置页或总结面板添加切片总结配置UI（估时：4h）
- [ ] Task-7.4.2: 前端 - 在总结面板显示切片处理进度和状态（估时：4h）
- [ ] Task-7.4.3: 后端 - 添加详细的日志记录用于性能分析和质量监控（估时：2h）

---

### US-7.5 转写流程交互优化 (Enhanced Transcription UX)
**作为** 用户
**我想要** 在上传文件后先确认配置选项，然后在专门的进度页面查看实时转写状态
**以便** 我可以控制转写参数，实时了解处理进度，并在需要时取消任务。

**验收标准**:
- [ ] 上传后显示确认对话框，用户可配置选项（语言、场景类型、切片参数）
- [ ] 转写过程中有专门的进度页面
- [ ] 实时显示当前转写句子（流式）
- [ ] 显示各阶段进度（音频提取、转写、切片）
- [ ] 用户可以取消正在进行的任务
- [ ] 完成后显示统计信息，用户确认后进入详情页

**任务拆解**:
- [ ] Task-7.5.1: 文件上传后元数据解析，返回文件信息和预估转写时间（估时：3h）
- [ ] Task-7.5.2: 创建转写确认对话框组件 `TranscriptionConfirmDialog.tsx`（估时：5h）
- [ ] Task-7.5.3: 转写确认API端点 `POST /api/projects/:id/confirm-transcription`（估时：2h）
- [ ] Task-7.5.4: 转写进度页面 `TranscriptionProgressPage.tsx`（估时：6h）
- [ ] Task-7.5.5: WebSocket/SSE实时通信实现（估时：6h）
- [ ] Task-7.5.6: 流式转写显示支持（估时：4h）
- [ ] Task-7.5.7: 任务取消功能 `POST /api/projects/:id/cancel-transcription`（估时：3h）
- [ ] Task-7.5.8: 转写完成统计卡片组件（估时：2h）
- [ ] Task-7.5.9: 修改上传页流程，集成确认对话框（估时：2h）
- [ ] Task-7.5.10: 数据库扩展 - 转写配置存储（估时：2h）

---

## Sprint 07 总结
- **总估时**: 约 70-90 小时
- **关键交付物**:
  - ⏳ 智能切片功能（切片算法、Token估算、单元测试）
  - ⏳ 分段提取功能（提取模式、处理服务、数据库扩展）
  - ⏳ 全局聚合功能（聚合服务、API重构、状态查询）
  - ⏳ 切片总结配置与监控（配置UI、进度显示、日志记录）
  - ⏳ 转写流程交互优化（确认对话框、进度页面、实时通信、任务取消）

---

## 参考资料

- `docs/长文本切片总结.md` - 详细的切片策略和实现代码
- `server/src/services/ollama.ts` - 现有的Ollama服务
- `server/src/app.ts` - 现有的总结API端点
- `server/python/worker.py` - Whisper转写结果格式
