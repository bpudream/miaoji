# Sprint 09: Qwen3 API 第三方模型测试与成本评估

**Sprint 目标**：
测试验证 Qwen3 API（328B 大模型）在长文本总结场景下的内容质量、性能表现和成本效益。通过官方 API 接入、本地预处理优化、质量对比测试和成本分析，为是否采用付费大模型提供数据支撑和决策依据。

**周期**：2024-12-XX ~ 2024-12-XX
**状态**：待开始 (Pending)

---

## User Stories

### US-9.1 Qwen3 API 调研与接入准备
**作为** 开发者
**我想要** 深入调研 Qwen3 API 官方文档，了解 API 能力、限制和定价策略
**以便** 能够正确评估技术可行性和成本，为后续集成做好准备。

**验收标准**:
- [ ] 完成 Qwen3 API 官方文档阅读，整理关键信息（API 端点、认证方式、请求格式、响应格式）
- [ ] 了解 Qwen3-328B 模型的能力边界（上下文长度、输出限制、并发限制、速率限制）
- [ ] 整理定价信息（输入 token 价格、输出 token 价格、不同模型规格对比）
- [ ] 完成 API Key 申请和配置（环境变量管理）
- [ ] 编写调研文档 `docs/qwen3-api-research.md`，包含 API 使用指南和关键参数说明

**任务拆解**:
- [ ] Task-9.1.1: 阅读 Qwen3 API 官方文档，整理 API 接口规范（端点、认证、请求/响应格式）（估时：3h）
- [ ] Task-9.1.2: 调研模型能力边界（上下文长度、输出限制、并发/速率限制、支持的功能）（估时：2h）
- [ ] Task-9.1.3: 整理定价信息（输入/输出 token 价格、不同模型规格对比、批量折扣等）（估时：2h）
- [ ] Task-9.1.4: 申请 API Key 并配置到环境变量（估时：1h）
- [ ] Task-9.1.5: 编写调研文档 `docs/qwen3-api-research.md`（估时：2h）

---

### US-9.2 成本评估与计算工具
**作为** 产品负责人
**我想要** 建立成本评估模型和计算工具
**以便** 能够准确预测不同场景下的 API 调用成本，为商业化决策提供数据支撑。

**验收标准**:
- [ ] 实现成本计算工具，支持根据文本长度、总结模式估算 token 消耗和费用
- [ ] 支持不同场景的成本对比（短文本 vs 长文本、直接总结 vs 切片总结）
- [ ] 成本计算考虑输入 token（原始文本 + Prompt）和输出 token（总结内容）
- [ ] 提供成本报告功能，展示单次调用和批量处理的成本预估
- [ ] 编写成本评估文档，包含典型场景的成本分析（如：1小时会议、30分钟销售电话等）

**任务拆解**:
- [ ] Task-9.2.1: 实现 Token 计数工具 `server/src/utils/tokenCounter.ts`，支持中英文混合文本（估时：3h）
- [ ] Task-9.2.2: 实现成本计算服务 `server/src/services/costCalculator.ts`，支持不同模型和场景（估时：4h）
- [ ] Task-9.2.3: 创建成本评估 API 端点 `POST /api/cost/estimate`，接收文本和模式返回成本预估（估时：2h）
- [ ] Task-9.2.4: 编写成本评估文档 `docs/qwen3-cost-analysis.md`，包含典型场景分析（估时：3h）

---

### US-9.3 本地预处理优化（Token 节省策略）
**作为** 系统
**我想要** 在调用付费 API 前对 Whisper 输出进行本地预处理
**以便** 通过编程手段减少不必要的 token 消耗，降低 API 调用成本。

**验收标准**:
- [ ] 实现文本清洗功能（去除重复内容、无意义语气词、时间戳格式化）
- [ ] 实现智能压缩功能（保留关键信息，去除冗余表达）
- [ ] 支持可配置的预处理策略（严格模式 vs 宽松模式）
- [ ] 预处理前后 token 数量对比报告（展示节省比例）
- [ ] 确保预处理不影响内容语义和关键信息完整性

**任务拆解**:
- [ ] Task-9.3.1: 实现文本清洗模块 `server/src/services/textPreprocessor.ts`（去除重复、语气词、格式化时间戳）（估时：4h）
- [ ] Task-9.3.2: 实现智能压缩功能（基于规则的关键信息保留，去除冗余表达）（估时：5h）
- [ ] Task-9.3.3: 添加预处理配置选项（严格/宽松模式，可配置清洗规则）（估时：2h）
- [ ] Task-9.3.4: 实现预处理效果统计（token 节省比例、处理前后对比）（估时：2h）
- [ ] Task-9.3.5: 编写单元测试，确保预处理不丢失关键信息（估时：3h）

---

### US-9.4 Qwen3 API 服务集成
**作为** 系统
**我想要** 集成 Qwen3 API 作为新的模型服务提供者
**以便** 能够使用 328B 大模型进行高质量的内容总结，同时保持与现有 Ollama 服务的兼容性。

**验收标准**:
- [ ] 创建 `Qwen3ApiService` 类，实现与 `OllamaService` 相同的接口规范
- [ ] 支持流式和非流式两种调用模式
- [ ] 实现错误处理和重试机制（网络错误、速率限制、token 超限等）
- [ ] 支持配置切换（可通过环境变量或配置选择使用 Ollama 还是 Qwen3 API）
- [ ] API 调用包含完整的日志记录（请求参数、响应时间、token 消耗、成本）

**任务拆解**:
- [ ] Task-9.4.1: 创建 `Qwen3ApiService` 类 `server/src/services/qwen3Api.ts`，实现基础 API 调用（估时：5h）
- [ ] Task-9.4.2: 实现流式响应支持（估时：3h）
- [ ] Task-9.4.3: 实现错误处理和重试机制（网络错误、速率限制、token 超限、API 错误码处理）（估时：4h）
- [ ] Task-9.4.4: 创建统一的模型服务接口 `ModelService`，支持动态切换（估时：4h）
- [ ] Task-9.4.5: 集成日志记录（请求参数、响应时间、token 消耗、成本计算）（估时：2h）

---

### US-9.5 技术迁移方案设计
**作为** 架构师
**我想要** 设计从本地 14B 模型到 Qwen3 API 的完整迁移方案
**以便** 如果决定采用付费模型，能够平滑、安全地进行技术迁移，最小化对现有功能的影响。

**验收标准**:
- [ ] 完成迁移方案文档，包含架构对比、迁移步骤、风险评估
- [ ] 设计向后兼容策略（支持双模型并行运行、灰度切换）
- [ ] 设计数据迁移方案（历史总结数据兼容性、用户配置迁移）
- [ ] 设计回滚方案（快速切回本地模型）
- [ ] 评估迁移对现有功能的影响（切片总结、流式输出、错误处理等）

**任务拆解**:
- [ ] Task-9.5.1: 编写迁移方案文档 `docs/qwen3-migration-plan.md`，包含架构对比和迁移步骤（估时：4h）
- [ ] Task-9.5.2: 设计双模型并行运行机制（支持 A/B 测试、灰度切换）（估时：3h）
- [ ] Task-9.5.3: 设计数据兼容性方案（历史数据格式、用户配置迁移）（估时：2h）
- [ ] Task-9.5.4: 设计回滚方案和应急预案（估时：2h）
- [ ] Task-9.5.5: 评估迁移对现有功能的影响，列出潜在问题和解决方案（估时：3h）

---

### US-9.6 质量对比测试框架
**作为** 测试工程师
**我想要** 建立系统化的质量对比测试框架
**以便** 能够客观、量化地评估 Qwen3-328B 与本地 14B 模型在总结质量上的差异。

**验收标准**:
- [ ] 建立测试数据集（包含不同类型的内容：会议、销售、教育、短视频等）
- [ ] 实现自动化对比测试工具（同时调用两个模型，对比输出结果）
- [ ] 定义质量评估指标（信息完整性、准确性、结构化程度、可读性）
- [ ] 生成对比测试报告（包含质量评分、成本对比、性能对比）
- [ ] 支持人工评估流程（专家评审、用户反馈收集）

**任务拆解**:
- [ ] Task-9.6.1: 准备测试数据集（选择 5-10 个不同类型的真实案例，包含短文本和长文本）（估时：3h）
- [ ] Task-9.6.2: 实现自动化对比测试工具 `server/src/tools/qualityComparator.ts`（估时：5h）
- [ ] Task-9.6.3: 定义质量评估指标和评分规则（估时：3h）
- [ ] Task-9.6.4: 实现对比测试报告生成功能（质量评分、成本对比、性能对比、差异分析）（估时：4h）
- [ ] Task-9.6.5: 设计人工评估流程和反馈收集机制（估时：2h）

---

### US-9.7 实际场景测试与成本监控
**作为** 产品负责人
**我想要** 在实际使用场景中测试 Qwen3 API，并实时监控成本消耗
**以便** 能够获得真实的使用体验和成本数据，为最终决策提供依据。

**验收标准**:
- [ ] 在实际项目中测试 Qwen3 API（至少 10 个不同类型的真实项目）
- [ ] 实现成本监控仪表板（实时显示 API 调用次数、token 消耗、费用累计）
- [ ] 记录每次调用的详细信息（项目类型、文本长度、处理时间、成本、质量评分）
- [ ] 生成成本使用报告（按项目类型、按时间段、按总结模式统计）
- [ ] 对比实际成本与预估成本的差异，分析原因

**任务拆解**:
- [ ] Task-9.7.1: 实现成本监控数据库表 `api_usage_logs`（记录每次调用的详细信息）（估时：3h）
- [ ] Task-9.7.2: 在 `Qwen3ApiService` 中集成成本记录功能（估时：2h）
- [ ] Task-9.7.3: 创建成本监控 API 端点 `GET /api/cost/monitor` 和 `GET /api/cost/report`（估时：3h）
- [ ] Task-9.7.4: 创建成本监控前端页面 `CostMonitorPage.tsx`（显示实时统计和图表）（估时：5h）
- [ ] Task-9.7.5: 执行实际场景测试（至少 10 个真实项目，记录详细数据）（估时：4h）
- [ ] Task-9.7.6: 生成成本使用报告和对比分析（估时：3h）

---

### US-9.8 测试总结与决策建议
**作为** 产品负责人
**我想要** 获得完整的测试总结报告和决策建议
**以便** 能够基于数据和测试结果，做出是否采用 Qwen3 API 的明智决策。

**验收标准**:
- [ ] 完成质量对比分析报告（14B vs 328B 的质量差异、适用场景）
- [ ] 完成成本效益分析报告（不同场景下的成本对比、ROI 分析）
- [ ] 完成性能对比报告（响应时间、并发能力、稳定性）
- [ ] 提供决策建议文档（包含推荐方案、风险提示、实施建议）
- [ ] 整理技术文档和最佳实践（API 使用规范、成本优化建议、故障排查指南）

**任务拆解**:
- [ ] Task-9.8.1: 整理质量对比分析报告（汇总测试数据、分析质量差异、总结适用场景）（估时：4h）
- [ ] Task-9.8.2: 整理成本效益分析报告（成本对比、ROI 分析、不同场景的成本模型）（估时：3h）
- [ ] Task-9.8.3: 整理性能对比报告（响应时间、并发能力、稳定性、错误率）（估时：2h）
- [ ] Task-9.8.4: 编写决策建议文档 `docs/qwen3-decision-recommendation.md`（估时：3h）
- [ ] Task-9.8.5: 整理技术文档和最佳实践（API 使用规范、成本优化建议、故障排查指南）（估时：3h）

---

## Sprint 09 总结
- **总估时**: 约 90-110 小时
- **关键交付物**:
  - ⏳ Qwen3 API 调研文档和接入准备
  - ⏳ 成本评估工具和分析报告
  - ⏳ 本地预处理优化模块（Token 节省策略）
  - ⏳ Qwen3 API 服务集成（支持流式、错误处理、日志记录）
  - ⏳ 技术迁移方案设计文档
  - ⏳ 质量对比测试框架和测试报告
  - ⏳ 成本监控系统和实际场景测试数据
  - ⏳ 完整的测试总结报告和决策建议

---

## 参考资料

- `docs/2.长文本切片总结.md` - 长文本切片策略和实现思路
- `server/src/services/ollama.ts` - 现有的 Ollama 服务实现
- Qwen3 API 官方文档 - [需要补充链接]
- `docs/v2/v2-sprint-07.md` - 智能切片总结相关功能

---

## 注意事项

1. **成本控制**：在测试阶段需要严格控制 API 调用成本，建议设置每日/每月预算上限
2. **数据安全**：确保 API Key 安全存储，不在日志中泄露敏感信息
3. **向后兼容**：所有新功能应该不影响现有的 Ollama 服务，支持平滑切换
4. **测试数据**：使用真实但脱敏的测试数据，避免泄露用户隐私
5. **文档完整性**：所有调研、测试、分析结果都应该形成文档，便于后续参考和决策
