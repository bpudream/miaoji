# 开发启动指南

本文档说明在开发阶段如何启动前后端服务，包括开发模式和生产模式的启动方式。

## 📋 目录

- [服务架构说明](#服务架构说明)
- [开发模式（推荐）](#开发模式推荐)
- [生产模式（Nginx）](#生产模式nginx)
- [环境变量配置](#环境变量配置)
- [常见问题](#常见问题)

## 🏗 服务架构说明

项目包含三个主要服务：

1. **前端服务（Frontend）**
   - 开发模式：Vite 开发服务器（端口 13737）
   - 生产模式：Nginx 提供静态文件（端口 80）

2. **后端服务（Backend）**
   - 开发环境：端口 3000
   - 生产环境：端口 13636

3. **Nginx 反向代理（可选）**
   - 生产模式使用：端口 80
   - 统一前后端访问入口

## 🚀 开发模式（推荐）

开发模式适合日常开发调试，支持热重载，修改代码后自动刷新。

### 启动步骤

#### 1. 配置环境变量

**后端配置** (`server/.env`):

**注意：** 如果 `server/.env` 文件不存在，后端会使用默认端口 3000。但为了明确配置，建议创建 `.env` 文件。

```bash
cd server
copy env.template .env
```

编辑 `server/.env`，设置开发环境端口：
```bash
BACKEND_PORT=3000
```

**说明：** 开发环境默认就是 3000 端口，即使不创建 `.env` 文件也能正常工作。但创建 `.env` 文件可以让配置更明确。

**前端配置** (`web/.env`):
```bash
cd web
copy env.template .env
```

编辑 `web/.env`，配置后端地址：
```bash
VITE_BACKEND_URL=http://localhost:3000
```

#### 2. 启动后端服务

打开第一个终端窗口：

```bash
cd server
npm install  # 首次运行需要安装依赖
npm run dev
```

后端服务将运行在 `http://localhost:3000`，支持热重载。

**验证后端服务：**
```bash
# 测试健康检查接口
curl http://localhost:3000/api/health
# 应该返回: {"status":"ok","timestamp":"..."}
```

#### 3. 启动前端开发服务器

打开第二个终端窗口：

```bash
cd web
npm install  # 首次运行需要安装依赖
npm run dev
```

前端开发服务器将运行在 `http://localhost:13737`，支持热重载和 HMR（热模块替换）。

#### 4. 访问应用

- **本机访问**: `http://localhost:13737`
- **局域网访问**: `http://192.168.x.x:13737`（替换为您的实际 IP）

**注意：** 如果需要在局域网访问，确保 Windows 防火墙已开放 13737 端口。

### 开发模式特点

✅ **优点：**
- 支持热重载，修改代码立即生效
- 支持 HMR，保持应用状态
- 详细的错误提示和调试信息
- 无需构建，启动快速

⚠️ **注意事项：**
- 需要同时运行前后端两个服务
- 前端开发服务器仅用于开发，不适合生产环境
- 需要开放防火墙端口（13737）才能局域网访问

## 🌐 生产模式（Nginx）

生产模式使用 Nginx 作为反向代理，统一前后端访问入口，适合测试生产环境配置或演示。

### 启动步骤

#### 1. 构建前端静态文件

```bash
cd web
npm run build
```

构建完成后，静态文件会生成在 `web/dist` 目录中。

#### 2. 配置后端环境变量

**重要：** 必须创建 `server/.env` 文件并配置端口，否则后端默认使用 3000 端口。

**创建并配置 `.env` 文件：**

```bash
cd server
copy env.template .env
```

编辑 `server/.env`，设置生产环境端口：
```bash
BACKEND_PORT=13636
```

**为什么必须是 13636？**

因为 `nginx/miaoji.conf` 配置文件中已经将 API 请求代理到 `http://localhost:13636/api/`：

```nginx
location /miaoji/api/ {
    proxy_pass http://localhost:13636/api/;
    # ...
}
```

**如果后端端口和 Nginx 配置不一致，API 请求会失败！**

**选项 1（推荐）：修改后端端口为 13636**
- 在 `server/.env` 中设置 `BACKEND_PORT=13636`
- 无需修改 Nginx 配置

**选项 2：修改 Nginx 配置为 3000**
- 保持后端使用默认 3000 端口（不创建 `.env` 或设置 `BACKEND_PORT=3000`）
- 修改 `nginx/miaoji.conf` 中的 `proxy_pass` 为 `http://localhost:3000/api/`

#### 3. 配置前端环境变量（可选）

如果使用 Nginx 代理，前端可以留空 `VITE_BACKEND_URL` 或使用相对路径。编辑 `web/.env.production`（如果存在）：

```bash
# 使用相对路径，通过 Nginx 代理访问
VITE_BACKEND_URL=
```

#### 4. 启动后端服务

**方式 1：开发模式启动（推荐用于测试）**

```bash
cd server
npm run dev
```

**方式 2：生产模式启动（推荐用于正式部署）**

```bash
cd server
npm run build  # 先构建 TypeScript 代码
npm start      # 运行编译后的代码
```

**说明：**
- `npm run dev`：使用 `tsx watch`，支持热重载，修改代码自动重启，日志输出更友好（美化格式）
- `npm start`：使用 `node dist/app.js`，需要先构建，性能更好，日志输出为 JSON 格式

**无论使用哪种方式，只要端口配置为 13636，都能正常工作。**

后端服务将运行在 `http://localhost:13636`。

#### 5. 配置并启动 Nginx

**5.1 检查 Nginx 配置**

确保 `D:\nginx\conf\miaoji.conf` 或 `C:\nginx\conf\miaoji.conf` 中的路径正确：

```nginx
# 前端静态文件路径（请修改为您的实际路径）
root C:/Users/bpudr/Documents/0.code/miaoji/web/dist;

# 后端 API 代理（确保端口为 13636）
location /miaoji/api/ {
    proxy_pass http://localhost:13636/api/;
    # ... 其他配置 ...
}
```

**5.2 测试 Nginx 配置**

```bash
cd D:\nginx  # 或 C:\nginx
nginx.exe -t
```

如果显示 `syntax is ok` 和 `test is successful`，说明配置正确。

**5.3 启动 Nginx**

```bash
cd D:\nginx  # 或 C:\nginx
nginx.exe
```

#### 6. 访问应用

- **本机访问**: `http://localhost/miaoji`
- **局域网访问**: `http://192.168.x.x/miaoji`（替换为您的实际 IP）

**注意：** 如果需要在局域网访问，确保 Windows 防火墙已开放 80 端口。

### 生产模式特点

✅ **优点：**
- 统一访问入口，无需端口号
- 后端不直接暴露，更安全
- 符合生产环境最佳实践
- 可以轻松添加 HTTPS、负载均衡等功能

⚠️ **注意事项：**
- 需要先构建前端静态文件
- 修改前端代码后需要重新构建
- 需要配置 Nginx（首次使用）

## ⚙️ 环境变量配置

### 后端环境变量 (`server/.env`)

| 变量名 | 说明 | 开发环境 | 生产环境 |
|--------|------|----------|----------|
| `BACKEND_PORT` | 后端服务端口 | `3000` | `13636` |
| `PYTHON_WORKER_PATH` | Python Worker 脚本路径 | `python/worker.py` | `python/worker.py` |
| `PYTHON_PATH` | Python 可执行文件路径 | `python\.venv\Scripts\python.exe` | `python\.venv\Scripts\python.exe` |
| `MODEL_PATH` | Whisper 模型路径 | `../models/large-v3` | `../models/large-v3` |
| `OLLAMA_HOST` | Ollama 服务地址 | `http://127.0.0.1:11434` | `http://127.0.0.1:11434` |

## 🔄 开发环境 vs 生产环境后端差异

### 核心代码

**后端核心代码是相同的**，通过环境变量和启动命令来区分不同环境。

### 主要差异

| 项目 | 开发环境 | 生产环境 |
|------|----------|----------|
| **端口** | `3000` | `13636` |
| **启动命令** | `npm run dev` | `npm start`（需先构建） |
| **启动方式** | `tsx watch src/app.ts`（热重载） | `node dist/app.js`（已编译） |
| **日志级别** | `debug`（更详细） | `info`（精简） |
| **日志格式** | 美化输出（pino-pretty） | JSON 格式 |
| **是否需要构建** | ❌ 不需要 | ✅ 需要（`npm run build`） |
| **代码热重载** | ✅ 支持 | ❌ 不支持 |

### 启动方式选择

**开发环境（端口 3000）：**
```bash
cd server
npm run dev  # 使用 tsx watch，支持热重载
```

**生产环境（端口 13636）：**

**方式 1：开发模式启动（适合测试）**
```bash
cd server
# 修改 .env 中的 BACKEND_PORT=13636
npm run dev  # 仍然使用 tsx watch，但端口为 13636
```

**方式 2：生产模式启动（推荐用于正式部署）**
```bash
cd server
npm run build  # 构建 TypeScript 代码
npm start      # 运行编译后的 JavaScript
```

### 注意事项

1. **端口配置是关键**：
   - 后端从 `server/.env` 文件读取 `BACKEND_PORT` 环境变量
   - **如果 `.env` 文件不存在或未设置 `BACKEND_PORT`，默认使用 3000 端口**
   - 开发环境：端口 3000（默认）
   - 生产环境（使用 Nginx）：**必须设置为 13636**，否则 Nginx 无法代理请求

2. **Nginx 配置必须与后端端口一致**：
   - 如果后端运行在 3000 端口，Nginx 配置中的 `proxy_pass` 必须改为 `http://localhost:3000/api/`
   - 如果后端运行在 13636 端口，Nginx 配置中的 `proxy_pass` 必须是 `http://localhost:13636/api/`
   - **推荐方案**：使用 13636 端口，这样无需修改 Nginx 配置

3. **如何检查后端实际运行的端口**：
   - 查看启动日志，会显示 `Server listening on port: XXXX`
   - 或者查看命令行输出的地址，如 `http://192.168.101.30:3000/`

4. **日志差异**：
   - 开发环境：控制台输出美化格式，便于调试
   - 生产环境：JSON 格式，便于日志收集和分析

5. **性能差异**：
   - `npm run dev`：启动稍慢（需要 TypeScript 编译），但支持热重载
   - `npm start`：启动更快（已编译），但不支持热重载

### 前端环境变量 (`web/.env`)

| 变量名 | 说明 | 开发环境 | 生产环境 |
|--------|------|----------|----------|
| `VITE_BACKEND_URL` | 后端 API 地址 | `http://localhost:3000` | 留空或相对路径 |

**开发环境示例：**
```bash
VITE_BACKEND_URL=http://localhost:3000
```

**生产环境示例（使用 Nginx 代理）：**
```bash
VITE_BACKEND_URL=
# 或
VITE_BACKEND_URL=/miaoji/api
```

## 🔧 常用命令

### 后端服务

```bash
cd server

# 开发模式（热重载）
npm run dev

# 生产模式
npm run build
npm start

# 运行测试
npm test
```

### 前端服务

```bash
cd web

# 开发模式（热重载）
npm run dev

# 构建生产版本
npm run build

# 预览生产构建
npm run preview

# 代码检查
npm run lint
```

### Nginx 服务

```bash
cd D:\nginx  # 或 C:\nginx

# 测试配置
nginx.exe -t

# 启动
nginx.exe

# 停止
nginx.exe -s stop

# 重新加载配置（不中断服务）
nginx.exe -s reload

# 查看进程
tasklist | findstr nginx
```

## ❓ 常见问题

### 1. 端口被占用

**问题：** 启动服务时提示 `EADDRINUSE: address already in use 0.0.0.0:13636` 或类似错误。

**原因：**
- 之前的后端进程没有正确关闭
- 其他程序正在使用该端口
- 端口处于 TIME_WAIT 状态（Windows 通常很快释放）
- 端口被系统“保留/排除端口段”（excluded port range）占用（例如 WSL/Hyper-V/部分安全软件），这种情况 `netstat` 可能看不到，但依然会 `EADDRINUSE`

**解决步骤：**

**步骤 1：查找占用端口的进程**

```bash
# 查看端口占用情况（替换端口号）
netstat -ano | findstr :13636   # 后端生产端口
netstat -ano | findstr :3000     # 后端开发端口
netstat -ano | findstr :13737   # 前端开发端口
netstat -ano | findstr :80      # Nginx 端口
```

如果 `netstat` 为空但依然报 `EADDRINUSE`，优先用 PowerShell 再查一次（更直观）：

```powershell
Get-NetTCPConnection -LocalPort 13636 -State Listen | Format-Table -AutoSize
```

> 注意：PowerShell 里 `sc` 通常是 `Set-Content` 的别名，查询服务请用 `sc.exe`。

如果也查不到监听进程，检查是否落在系统排除端口段（**这是最容易被漏掉的原因**）：

```powershell
# 直接 grep “13636” 可能会漏（netsh 输出是 起始端口 + 数量，不会列出区间内每个端口）
$target = 13636
$lines = netsh interface ipv4 show excludedportrange protocol=tcp
$ranges = foreach ($l in $lines) {
  if ($l -match '^\s*(\d+)\s+(\d+)\s*$') {
    $start = [int]$Matches[1]
    $count = [int]$Matches[2]
    [pscustomobject]@{ Start=$start; End=($start + $count - 1) }
  }
}
$hit = $ranges | Where-Object { $target -ge $_.Start -and $target -le $_.End }
if ($hit) { $hit | Format-Table -AutoSize } else { 'Not in excluded port range.' }
```

**步骤 2：查看进程详情**

找到占用端口的 PID（最后一列），然后查看进程名称：
```bash
tasklist | findstr <PID>
```

**步骤 3：结束占用端口的进程**

```bash
# 结束指定进程（替换 <PID> 为实际进程 ID）
taskkill /PID <PID> /F

# 如果是 Node.js 进程，也可以直接结束所有 node 进程（谨慎使用）
taskkill /IM node.exe /F
```

**步骤 4：如果仍然无法启动，等待几秒后重试**

Windows 系统释放端口可能需要几秒钟。等待 5-10 秒后再次启动服务。

**示例：**

```bash
# 1. 查找占用 13636 端口的进程
netstat -ano | findstr :13636

# 输出示例：
# TCP    0.0.0.0:13636   0.0.0.0:0    LISTENING    12345

# 2. 查看进程名称
tasklist | findstr 12345

# 输出示例：
# node.exe    12345 Console    10    50,000 K

# 3. 结束进程
taskkill /PID 12345 /F

# 4. 重新启动后端服务
cd server
npm start
```

**预防措施：**
- 使用 `Ctrl+C` 正确停止服务，而不是直接关闭终端
- 如果使用 PM2，使用 `pm2 stop` 和 `pm2 delete` 正确停止进程
- 开发时如果频繁重启，可以考虑使用不同的端口

### 2. 前端无法连接后端

**问题：** 前端页面显示 API 请求失败。

**检查：**
1. 确认后端服务正在运行
2. 检查 `web/.env` 中的 `VITE_BACKEND_URL` 是否正确
3. 检查后端端口是否与配置一致
4. 查看浏览器控制台和网络请求

**解决：**
```bash
# 测试后端健康检查接口
curl http://localhost:3000/api/health  # 开发环境
curl http://localhost:13636/api/health # 生产环境
```

### 2.1. 后端端口与 Nginx 配置不匹配

**问题：** 使用 Nginx 时，后端运行在 3000 端口，但 Nginx 配置期望 13636 端口，导致 API 请求失败。

**症状：**
- 后端启动日志显示：`Server listening on port: 3000` 或 `http://192.168.101.30:3000/`
- 通过 Nginx 访问时，API 请求返回 502 或连接失败
- 直接访问 `http://localhost:3000/api/health` 可以成功，但通过 Nginx 访问失败

**原因：**
- `server/.env` 文件不存在或 `BACKEND_PORT` 未设置为 13636
- 后端默认使用 3000 端口，但 Nginx 配置中 `proxy_pass` 指向 13636

**解决方案（推荐）：修改后端端口为 13636**

```bash
# 1. 创建或编辑 server/.env 文件
cd server
copy env.template .env

# 2. 编辑 .env 文件，设置端口为 13636
# 在 .env 文件中添加或修改：
BACKEND_PORT=13636

# 3. 重启后端服务
npm run dev  # 或 npm start
```

**验证：**
- 查看后端启动日志，应该显示 `Server listening on port: 13636`
- 测试：`curl http://localhost:13636/api/health`

**替代方案：修改 Nginx 配置为 3000 端口**

如果不想修改后端端口，可以修改 Nginx 配置：

```nginx
# 编辑 nginx/miaoji.conf，将第 42 行改为：
location /miaoji/api/ {
    proxy_pass http://localhost:3000/api/;  # 改为 3000
    # ... 其他配置保持不变 ...
}

# 同时修改健康检查端点（第 62 行）：
location /miaoji/health {
    proxy_pass http://localhost:3000/api/health;  # 改为 3000
    access_log off;
}
```

然后重新加载 Nginx：
```bash
cd D:\nginx  # 或 C:\nginx
nginx.exe -s reload
```

### 3. 局域网无法访问

**问题：** 本机可以访问，但其他设备无法访问。

**解决：**
```powershell
# 开放前端开发端口（开发模式）
New-NetFirewallRule -DisplayName "Miaoji Frontend Dev (13737)" -Direction Inbound -LocalPort 13737 -Protocol TCP -Action Allow

# 开放 HTTP 端口（生产模式）
New-NetFirewallRule -DisplayName "Miaoji HTTP (80)" -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow
```

### 4. Nginx 无法启动

**问题：** 运行 `nginx.exe` 后没有反应或报错。

**检查：**
1. 检查端口 80 是否被占用
2. 检查配置文件语法：`nginx.exe -t`
3. 查看错误日志：`D:\nginx\logs\error.log`

**解决：**
```bash
# 检查端口占用
netstat -ano | findstr :80

# 测试配置
nginx.exe -t

# 查看错误日志
type D:\nginx\logs\error.log
```

### 5. 前端页面显示 404（生产模式）

**问题：** 使用 Nginx 访问时显示 404。

**检查：**
1. 确认 `web/dist` 目录存在且包含 `index.html`
2. 检查 Nginx 配置中的路径是否正确
3. 确认访问路径是 `/miaoji` 而不是根路径 `/`

**解决：**
```bash
# 重新构建前端
cd web
npm run build

# 检查构建输出
dir web\dist
```

### 6. 修改代码后不生效（开发模式）

**问题：** 修改代码后页面没有自动刷新。

**检查：**
1. 确认使用的是 `npm run dev` 而不是 `npm start`
2. 检查终端是否有错误信息
3. 尝试手动刷新浏览器（Ctrl+F5）

**解决：**
```bash
# 停止服务（Ctrl+C），然后重新启动
cd server
npm run dev

# 或
cd web
npm run dev
```

## 📝 快速参考

### 开发模式启动（推荐）

```bash
# 终端 1：启动后端
cd server
npm run dev

# 终端 2：启动前端
cd web
npm run dev

# 访问：http://localhost:13737
```

### 生产模式启动

```bash
# 1. 构建前端
cd web
npm run build

# 2. 启动后端
cd server
npm run dev

# 3. 启动 Nginx
cd D:\nginx
nginx.exe

# 访问：http://localhost/miaoji
```

## 🎯 选择建议

- **日常开发**：使用开发模式，支持热重载，调试方便
- **测试生产配置**：使用生产模式，验证 Nginx 配置和部署流程
- **演示给他人**：使用生产模式，访问更简单（无需端口号）

---

**提示：** 如果遇到其他问题，请查看项目文档或提交 Issue。
