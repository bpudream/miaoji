# 前端打包和部署步骤

## 1. 配置生产环境变量（重要）

在构建前端之前，需要配置生产环境的后端地址：

### 1.1 创建生产环境配置文件

在 `web` 目录下创建 `.env.production` 文件：

```bash
cd web
copy env.template .env.production
```

### 1.2 编辑 `.env.production` 文件

编辑 `web/.env.production`，设置后端地址：

```bash
# 如果通过 Nginx 反向代理（推荐），可以留空或注释掉
# VITE_BACKEND_URL=

# 如果直接访问后端，使用端口 13636
VITE_BACKEND_URL=http://localhost:13636
```

**重要说明：**
- 生产环境后端端口必须是 **13636**
- 如果使用 Nginx 反向代理，可以留空（前端会使用相对路径）
- 如果不使用 Nginx，必须设置为 `http://localhost:13636` 或实际服务器地址

### 1.3 验证配置

确认 `.env.production` 文件存在且配置正确：

```bash
# Windows
type web\.env.production

# 应该看到 VITE_BACKEND_URL 配置
```

## 2. 构建前端

在 `web` 目录执行：

```bash
cd web
npm run build
```

构建完成后，会在 `web/dist` 目录生成静态文件。

**注意：** 构建时会自动使用 `.env.production` 中的配置，确保生产环境使用正确的后端端口。

## 2. 检查构建输出

确认以下文件存在：
- `web/dist/index.html`
- `web/dist/assets/` 目录（包含 JS、CSS 等资源）

## 3. 配置 Nginx

### 3.1 复制配置文件

将 `nginx/miaoji.conf` 复制到 Nginx 的 `conf` 目录：
```bash
# 假设 Nginx 安装在 C:\nginx
copy nginx\miaoji.conf C:\nginx\conf\miaoji.conf
```

### 3.2 修改配置文件中的路径

编辑 `C:\nginx\conf\miaoji.conf`，修改以下路径：

```nginx
# 第 19 行：修改为您的实际项目路径
alias C:/Users/bpudr/Documents/0.code/miaoji/web/dist/;
```

**重要：**
- 使用正斜杠 `/` 而不是反斜杠 `\`
- 路径末尾必须有斜杠 `/`
- 使用绝对路径

### 3.3 修改主配置文件

编辑 `C:\nginx\conf\nginx.conf`：

1. 注释掉默认的 server 块（第 35-79 行）
2. 在 `http` 块的最后添加：
   ```nginx
   include miaoji.conf;
   ```

## 4. 启动服务

### 4.1 配置后端服务端口

确保后端服务运行在端口 **13636**（生产环境必须使用此端口）：

#### 4.1.1 创建后端环境配置文件

在 `server` 目录下创建 `.env` 文件：

```bash
cd server
copy env.template .env
```

#### 4.1.2 编辑 `.env` 文件

编辑 `server/.env`，设置后端端口：

```bash
# 生产环境必须使用 13636 端口
BACKEND_PORT=13636
```

#### 4.1.3 启动后端服务

```bash
cd server
npm run dev
# 或使用生产模式
npm start
```

**重要：** 后端服务必须运行在 **13636** 端口，因为 Nginx 配置中已经将 API 请求代理到此端口。

#### 4.1.4 验证后端服务

确保后端运行在 `http://localhost:13636`：

```bash
# 测试健康检查接口
curl http://localhost:13636/api/health

# 应该返回: {"status":"ok","timestamp":"..."}
```

**注意：** 前端不需要运行服务器，只需要构建好的静态文件即可。

### 4.2 测试 Nginx 配置

```bash
cd C:\nginx
nginx.exe -t
```

如果显示 `syntax is ok` 和 `test is successful`，说明配置正确。

### 4.3 启动 Nginx

```bash
nginx.exe
```

## 5. 测试访问

### 5.1 本机测试

在浏览器访问：
- 前端：`http://localhost/miaoji`
- API 健康检查：`http://localhost/miaoji/api/health`

### 5.2 手机测试

在手机浏览器访问：
- `http://192.168.101.30/miaoji`（替换为您的实际 IP）

## 6. 常见问题排查

### 问题 1：页面显示 404

**检查：**
- 确认 `web/dist` 目录存在且包含文件
- 检查 Nginx 配置中的 `alias` 路径是否正确
- 查看 Nginx 错误日志：`C:\nginx\logs\miaoji_error.log`

**解决：**
```bash
# 重新构建
cd web
npm run build

# 检查路径
dir C:\Users\bpudr\Documents\0.code\miaoji\web\dist
```

### 问题 2：静态资源（JS/CSS）加载失败

**检查：**
- 确认 Vite 构建时 `base` 配置正确（应该是 `/miaoji/`）
- 检查浏览器控制台的网络请求，看资源路径是否正确

**解决：**
```bash
# 重新构建（确保使用生产环境）
cd web
npm run build
```

### 问题 3：API 请求失败

**检查：**
- 确认后端服务正在运行
- 测试后端直接访问：`http://localhost:13636/api/health`
- 检查 Nginx 配置中的 `proxy_pass` 是否正确

**解决：**
```bash
# 检查后端服务
curl http://localhost:13636/api/health

# 重新加载 Nginx 配置
nginx.exe -s reload
```

### 问题 4：Nginx 无法启动

**检查：**
- 端口 80 是否被占用：`netstat -ano | findstr :80`
- 配置文件语法是否正确：`nginx.exe -t`
- 查看错误日志：`C:\nginx\logs\error.log`

**解决：**
```bash
# 如果端口被占用，可以：
# 1. 关闭占用端口的程序
# 2. 或修改 Nginx 配置使用其他端口（如 8080）
```

## 7. 重新部署流程

如果修改了前端代码，需要重新部署：

```bash
# 1. 确认生产环境配置（.env.production）正确
# 2. 重新构建
cd web
npm run build

# 3. 重新加载 Nginx（无需重启，不中断服务）
cd C:\nginx
nginx.exe -s reload
```

**重要：** 每次重新构建前，确保 `.env.production` 文件中的 `VITE_BACKEND_URL` 配置正确。

## 8. 开发模式 vs 生产模式

### 开发模式（热重载）
```bash
cd web
# 使用 .env 文件（后端端口 3000）
npm run dev
# 访问：http://localhost:13737
# 后端：http://localhost:3000
```

**架构说明：**
- 前端开发服务器运行在 **13737** 端口
- 后端服务运行在 **3000** 端口
- 前端直接访问后端 API（不通过 Nginx）

### 生产模式（Nginx 静态文件服务 + API 代理）
```bash
cd web
# 使用 .env.production 文件（后端端口 13636）
npm run build
# 启动 Nginx
# 访问：http://192.168.101.30/miaoji
# 后端：http://localhost:13636（通过 Nginx 代理）
```

**架构说明：**
- **前端不需要运行服务器**，是静态文件（在 `web/dist` 目录）
- Nginx 监听 **80** 端口，直接服务静态文件
- 后端服务运行在 **13636** 端口
- Nginx 将 `/miaoji/api/` 请求代理到 `localhost:13636/api/`
- 用户访问 `http://192.168.101.30/miaoji/` 时，前端代码会自动使用相对路径 `/miaoji/api` 访问后端

### 端口配置总结

| 环境 | 前端 | 后端 | Nginx | 配置文件 |
|------|------|------|-------|---------|
| 开发环境 | 13737 (dev server) | 3000 | 不需要 | `web/.env` |
| 生产环境 | 静态文件 | 13636 | 80 | `web/.env.production` |

**重要说明：**
- 开发环境：前端服务器运行在 13737，后端在 3000
- 生产环境：**前端是静态文件，不需要运行服务器**，由 Nginx 在 80 端口直接服务；后端在 13636
- 13737 端口**只在开发环境使用**，生产环境不需要

## 9. 验证清单

部署完成后，请确认：

- [ ] `.env.production` 文件已创建并配置正确
- [ ] 后端 `.env` 文件中 `BACKEND_PORT=13636`
- [ ] 后端服务运行在 `http://localhost:13636`
- [ ] 前端页面可以正常访问
- [ ] 页面样式和功能正常
- [ ] API 请求可以正常工作（检查浏览器控制台网络请求）
- [ ] 文件上传功能正常
- [ ] 手机访问正常
- [ ] 二维码扫描可以正常访问

### 验证后端端口配置

在浏览器开发者工具中，检查 API 请求的 URL：
- 如果通过 Nginx 代理：应该是 `/miaoji/api/...`
- 如果直接访问：应该是 `http://localhost:13636/api/...`

**不应该出现端口 3000 的请求**（那是开发环境的端口）。

## 10. 快速命令参考

```bash
# 构建前端
cd web && npm run build

# 测试 Nginx 配置
cd C:\nginx && nginx.exe -t

# 启动 Nginx
cd C:\nginx && nginx.exe

# 重新加载 Nginx（不中断服务）
cd C:\nginx && nginx.exe -s reload

# 停止 Nginx
cd C:\nginx && nginx.exe -s stop

# 查看 Nginx 进程
tasklist | findstr nginx
```

