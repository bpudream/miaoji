# 前端打包和部署步骤

## 1. 构建前端

在项目根目录执行：

```bash
cd web
npm run build
```

构建完成后，会在 `web/dist` 目录生成静态文件。

## 2. 检查构建输出

确认以下文件存在：
- `web/dist/index.html`
- `web/dist/assets/` 目录（包含 JS、CSS 等资源）

## 3. 配置 Nginx

### 3.1 复制配置文件

将 `nginx/miaoji.conf` 复制到 Nginx 的 `conf` 目录：
```bash
# 假设 Nginx 安装在 C:\nginx
copy nginx\miaoji.conf C:\nginx\conf\miaoji.conf
```

### 3.2 修改配置文件中的路径

编辑 `C:\nginx\conf\miaoji.conf`，修改以下路径：

```nginx
# 第 19 行：修改为您的实际项目路径
alias C:/Users/bpudr/Documents/0.code/miaoji/web/dist/;
```

**重要：**
- 使用正斜杠 `/` 而不是反斜杠 `\`
- 路径末尾必须有斜杠 `/`
- 使用绝对路径

### 3.3 修改主配置文件

编辑 `C:\nginx\conf\nginx.conf`：

1. 注释掉默认的 server 块（第 35-79 行）
2. 在 `http` 块的最后添加：
   ```nginx
   include miaoji.conf;
   ```

## 4. 启动服务

### 4.1 启动后端服务

```bash
cd server
npm run dev
```

确保后端运行在 `http://localhost:13636`

### 4.2 测试 Nginx 配置

```bash
cd C:\nginx
nginx.exe -t
```

如果显示 `syntax is ok` 和 `test is successful`，说明配置正确。

### 4.3 启动 Nginx

```bash
nginx.exe
```

## 5. 测试访问

### 5.1 本机测试

在浏览器访问：
- 前端：`http://localhost/miaoji`
- API 健康检查：`http://localhost/miaoji/api/health`

### 5.2 手机测试

在手机浏览器访问：
- `http://192.168.101.30/miaoji`（替换为您的实际 IP）

## 6. 常见问题排查

### 问题 1：页面显示 404

**检查：**
- 确认 `web/dist` 目录存在且包含文件
- 检查 Nginx 配置中的 `alias` 路径是否正确
- 查看 Nginx 错误日志：`C:\nginx\logs\miaoji_error.log`

**解决：**
```bash
# 重新构建
cd web
npm run build

# 检查路径
dir C:\Users\bpudr\Documents\0.code\miaoji\web\dist
```

### 问题 2：静态资源（JS/CSS）加载失败

**检查：**
- 确认 Vite 构建时 `base` 配置正确（应该是 `/miaoji/`）
- 检查浏览器控制台的网络请求，看资源路径是否正确

**解决：**
```bash
# 重新构建（确保使用生产环境）
cd web
npm run build
```

### 问题 3：API 请求失败

**检查：**
- 确认后端服务正在运行
- 测试后端直接访问：`http://localhost:13636/api/health`
- 检查 Nginx 配置中的 `proxy_pass` 是否正确

**解决：**
```bash
# 检查后端服务
curl http://localhost:13636/api/health

# 重新加载 Nginx 配置
nginx.exe -s reload
```

### 问题 4：Nginx 无法启动

**检查：**
- 端口 80 是否被占用：`netstat -ano | findstr :80`
- 配置文件语法是否正确：`nginx.exe -t`
- 查看错误日志：`C:\nginx\logs\error.log`

**解决：**
```bash
# 如果端口被占用，可以：
# 1. 关闭占用端口的程序
# 2. 或修改 Nginx 配置使用其他端口（如 8080）
```

## 7. 重新部署流程

如果修改了前端代码，需要重新部署：

```bash
# 1. 重新构建
cd web
npm run build

# 2. 重新加载 Nginx（无需重启，不中断服务）
cd C:\nginx
nginx.exe -s reload
```

## 8. 开发模式 vs 生产模式

### 开发模式（热重载）
```bash
cd web
npm run dev
# 访问：http://localhost:13737
```

### 生产模式（Nginx 代理）
```bash
cd web
npm run build
# 启动 Nginx
# 访问：http://localhost/miaoji
```

## 9. 验证清单

部署完成后，请确认：

- [ ] 前端页面可以正常访问
- [ ] 页面样式和功能正常
- [ ] API 请求可以正常工作
- [ ] 文件上传功能正常
- [ ] 手机访问正常
- [ ] 二维码扫描可以正常访问

## 10. 快速命令参考

```bash
# 构建前端
cd web && npm run build

# 测试 Nginx 配置
cd C:\nginx && nginx.exe -t

# 启动 Nginx
cd C:\nginx && nginx.exe

# 重新加载 Nginx（不中断服务）
cd C:\nginx && nginx.exe -s reload

# 停止 Nginx
cd C:\nginx && nginx.exe -s stop

# 查看 Nginx 进程
tasklist | findstr nginx
```

