# 后端服务打包和部署指南

## 1. 打包步骤

### 1.1 使用打包脚本（推荐）

使用提供的打包脚本可以一键完成所有打包步骤：

```bash
cd server
package.bat
```

打包脚本会自动：
1. 清理旧的构建文件
2. 编译 TypeScript 代码
3. 创建完整的发布包（包含所有必要文件）
4. 安装生产依赖
5. 创建必要的目录结构

打包完成后，会在 `server/release/server/` 目录生成完整的发布包。

### 1.2 手动打包步骤

如果需要手动打包：

#### 1.2.1 安装依赖

```bash
cd server
npm install
```

#### 1.2.2 编译 TypeScript

```bash
npm run build
```

编译完成后，TypeScript 代码会被编译到 `server/dist` 目录。

#### 1.2.3 创建发布包

需要手动复制以下文件到发布目录：

```bash
# 创建发布目录
mkdir release\server

# 复制编译后的文件
xcopy /E /I dist release\server\dist

# 复制 Python worker
xcopy /E /I /Y python release\server\python

# 复制配置文件
copy package.json release\server\
copy package-lock.json release\server\
copy env.template release\server\

# 创建必要目录
mkdir release\server\data
mkdir release\server\uploads

# 安装生产依赖
cd release\server
npm install --production
```

### 1.3 验证打包输出

确认以下文件和目录存在：
- `release/server/dist/app.js` - 主应用入口
- `release/server/dist/` 目录下包含所有编译后的 `.js` 文件
- `release/server/python/worker.py` - Python Worker 脚本
- `release/server/node_modules/` - 生产依赖
- `release/server/package.json` - 项目配置

## 2. 打包目录结构

### 2.1 发布包结构

使用打包脚本后，会在 `server/release/server/` 目录生成完整的发布包：

```
release/
└── server/                  # 完整的发布包目录
    ├── dist/                # 编译后的 JavaScript 文件（必需）
    │   ├── app.js           # 主应用入口
    │   ├── app.js.map       # Source map
    │   ├── db.js
    │   ├── queue.js
    │   └── services/
    │       ├── audio.js
    │       ├── fileHash.js
    │       ├── ollama.js
    │       ├── projectPath.js
    │       └── storage.js
    ├── python/              # Python Worker 脚本（必需）
    │   └── worker.py
    ├── data/                # 数据库目录（空目录，运行时创建数据库文件）
    ├── uploads/             # 上传文件目录（空目录，运行时使用）
    ├── node_modules/        # Node.js 生产依赖（必需）
    ├── package.json         # 项目配置（必需）
    ├── package-lock.json    # 依赖锁定文件（推荐）
    └── env.template         # 环境变量模板（参考）
```

### 2.2 重要说明

**发布包是独立的**：`release/server/` 目录包含了运行服务所需的所有文件，可以直接复制到目标服务器使用。

**需要手动配置的文件**：
- `.env` - 需要从 `env.template` 复制并配置

**运行时创建的目录和文件**：
- `data/miaoji.db` - 数据库文件（首次运行时自动创建）
- `uploads/` - 上传的文件（运行时自动创建）

**外部依赖**（不在发布包中，需要在目标服务器上安装）：
- Python 环境及 `faster-whisper` 库
- FFmpeg
- Ollama 服务
- `models/large-v3/` 目录（在项目根目录，不在 server 目录下）

## 3. 环境配置

### 3.1 创建环境变量文件

```bash
cd server
cp env.template .env
```

### 3.2 配置环境变量

编辑 `.env` 文件：

```bash
# 后端服务端口
BACKEND_PORT=3000
```

> **注意**：`.env` 文件不应提交到版本控制系统，应添加到 `.gitignore`。

## 4. 生产环境部署

### 4.1 安装生产依赖

```bash
cd server
npm install --production
```

这会安装 `dependencies` 中的包，但不会安装 `devDependencies`。

### 4.2 启动服务

#### 方式 1：直接启动（开发/测试）

```bash
npm start
```

#### 方式 2：使用 PM2（推荐生产环境）

```bash
# 安装 PM2（全局）
npm install -g pm2

# 启动服务
pm2 start dist/app.js --name miaoji-server

# 查看状态
pm2 status

# 查看日志
pm2 logs miaoji-server

# 设置开机自启动
pm2 startup
pm2 save
```

#### 方式 3：使用 Windows 服务（Windows 系统）

可以使用 `node-windows` 或 `pm2-windows-service` 将服务注册为 Windows 服务。

## 5. 依赖说明

### 5.1 Node.js 依赖

后端服务需要以下运行时依赖：
- `fastify` - Web 框架
- `@fastify/cors` - CORS 支持
- `@fastify/multipart` - 文件上传支持
- `better-sqlite3` - SQLite 数据库
- `dotenv` - 环境变量管理
- `fluent-ffmpeg` - 音视频处理
- `ollama` - Ollama API 客户端

### 5.2 Python 依赖

Python Worker 需要以下依赖（在 Python 虚拟环境中安装）：

```bash
# 激活虚拟环境
cd server
# 如果使用 venv
# source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate     # Windows

# 安装依赖
pip install faster-whisper
```

### 5.3 系统依赖

- **FFmpeg**：需要安装 FFmpeg 并添加到系统 PATH
- **Ollama**：需要安装并运行 Ollama 服务
- **CUDA**（可选）：如果使用 GPU 加速，需要安装 CUDA 和 cuDNN

## 6. 打包脚本说明

项目已包含打包脚本 `server/package.bat`，可以一键完成所有打包步骤。

### 6.1 打包脚本功能

打包脚本会自动完成：
1. ✅ 清理旧的构建文件和发布目录
2. ✅ 编译 TypeScript 代码
3. ✅ 验证编译输出
4. ✅ 创建完整的发布包（复制所有必要文件）
5. ✅ 安装生产依赖
6. ✅ 创建必要的目录结构

### 6.2 使用方法

```bash
cd server
package.bat
```

### 6.3 输出位置

打包完成后，完整的发布包位于：
```
server/release/server/
```

这个目录包含了运行服务所需的所有文件，可以直接：
- 复制到目标服务器
- 压缩为 ZIP 文件分发
- 直接在该目录运行 `npm start`

### 6.4 发布包部署

将 `release/server/` 目录复制到目标服务器后：

```bash
# 1. 进入发布包目录
cd release/server

# 2. 配置环境变量
copy env.template .env
# 编辑 .env 文件，配置 BACKEND_PORT 等

# 3. 启动服务
npm start
```

## 7. 部署检查清单

部署前请确认：

- [ ] TypeScript 代码已编译到 `dist/` 目录
- [ ] `dist/app.js` 文件存在且可执行
- [ ] `.env` 文件已创建并配置正确
- [ ] `node_modules/` 已安装（生产依赖）
- [ ] Python 虚拟环境已配置
- [ ] Python 依赖已安装（`faster-whisper` 等）
- [ ] FFmpeg 已安装并可用
- [ ] Ollama 服务已安装并运行
- [ ] 数据库目录 `data/` 有写入权限
- [ ] 上传目录 `uploads/` 有写入权限
- [ ] 存储路径配置正确（如果使用自定义存储路径）

## 8. 常见问题

### 问题 1：编译失败

**检查：**
- TypeScript 版本是否正确：`npx tsc --version`
- `tsconfig.json` 配置是否正确
- 代码中是否有语法错误

**解决：**
```bash
# 清理并重新编译
rm -rf dist
npm run build
```

### 问题 2：运行时找不到模块

**检查：**
- `node_modules/` 是否已安装
- 是否使用了 `npm install --production`（可能缺少 devDependencies）

**解决：**
```bash
# 重新安装所有依赖
npm install
```

### 问题 3：Python Worker 无法启动

**检查：**
- Python 环境是否正确
- `faster-whisper` 是否已安装
- 模型文件是否存在（`models/large-v3/`）

**解决：**
```bash
# 检查 Python 环境
python --version

# 重新安装 Python 依赖
pip install faster-whisper
```

### 问题 4：端口被占用

**检查：**
```bash
# Windows
netstat -ano | findstr :3000

# Linux/Mac
lsof -i :3000
```

**解决：**
- 修改 `.env` 文件中的 `BACKEND_PORT`
- 或关闭占用端口的进程

## 9. 快速命令参考

```bash
# 开发模式（热重载）
npm run dev

# 编译 TypeScript
npm run build

# 启动生产服务
npm start

# 运行测试
npm test

# 安装生产依赖
npm install --production

# 查看服务日志（如果使用 PM2）
pm2 logs miaoji-server
```

## 10. 版本发布流程

1. **更新版本号**
   ```bash
   # 在 package.json 中更新 version 字段
   ```

2. **编译代码**
   ```bash
   npm run build
   ```

3. **测试**
   ```bash
   npm test
   npm start  # 手动测试
   ```

4. **打包**
   - 创建发布包（可选）
   - 或直接部署 `server/` 目录

5. **部署**
   - 将打包后的文件复制到目标服务器
   - 配置环境变量
   - 启动服务

