# 后端服务打包指南（面向开发者）

> 目标：指导后端开发者产出 `release/server` 发布包并附带必要资产，方便交付给实施或客户团队使用。

## 1. 范围与约定

- 打包动作在 `server/` 目录内完成。
- 交付物包含 `release/server`（服务主体）、`release/scripts`（服务脚本）、`release/tools`（NSSM 等工具）以及 `release/models/`（供 Python Worker 使用）。
- 本文档只覆盖“如何打包”。“打包后的安装/运行”请参考《后端服务安装指南》。

## 2. 前置准备

| 项目 | 要求 |
| --- | --- |
| Node.js / npm | Node 18+（需可运行 `npm run build`）|
| Python | 若需要一起交付 `python/` 目录，请确认脚本齐全 |
| Git / 依赖 | 建议先执行一次 `npm install` 保证开发依赖完整 |
| 模型文件 | `models/large-v3` 目录需要放在仓库根目录（与 `server/` 同级）|

## 3. 使用 `package.bat`（推荐）

### 3.1 执行命令

```bash
cd server
package.bat
```

### 3.2 脚本执行内容

脚本按顺序完成：

1. 清理：删除旧的 `dist/` 与 `release/`。
2. 编译：调用 `npm run build` 生成 `dist/`。
3. 验证：确认 `dist/app.js` 存在。
4. 打包：
   - 复制 `dist/`、`python/` 到 `release/server/`。
   - 复制 `scripts/` 到 `release/scripts/`，复制 `tools/` 到 `release/tools/`。
   - 若存在 `..\models`，复制到 `release/models/`。
   - 拷贝 `package.json`、`package-lock.json`、`env.template`，并创建 `data/`、`uploads/`。
5. 环境提示：检查 `release/server/.env` 是否已就绪。

> ⚠️ 脚本**不会**安装 `node_modules`。依赖需在目标机器（release 根目录）执行 `scripts\install-dependencies.bat` 或手动运行 `npm install --production`。

### 3.3 输出目录与说明

```
release/
├── server/
│   ├── dist/              # 编译后的 JS
│   ├── python/            # Python worker（若存在）
│   ├── data/ uploads/     # 预创建目录
│   ├── package.json / package-lock.json
│   └── env.template
├── scripts/               # 安装依赖、服务注册、启停脚本
├── tools/                 # NSSM 与下载脚本
└── models/
    └── large-v3/          # 需要手动确认是否复制成功
```

> 建议将 `release/` 目录整体压缩交付，以免遗漏模型或脚本。

### 3.4 常见提示

- 若未找到 `python/`、`tools/` 或 `..\models`，脚本会输出 WARNING，需开发者自行补齐。
- 若 `npm run build` 失败，脚本立即退出；请先修复 TypeScript 错误再重试。

## 4. 手动打包步骤（可选）

适用于需要自定义打包流程或在非 Windows 环境执行的场景。

1. 编译：
   ```bash
   cd server
   npm run build
   ```
2. 创建目录：
   ```bash
   rmdir /s /q release 2>nul
   mkdir release\server
   ```
3. 复制资源：
   ```bash
   xcopy /E /I dist release\server\dist
   xcopy /E /I python release\server\python
   xcopy /E /I scripts release\scripts
   xcopy /E /I tools release\tools
   copy package.json release\server\
   copy package-lock.json release\server\
   copy env.template release\server\
   mkdir release\server\data
   mkdir release\server\uploads
   ```
4. 模型文件（在仓库根目录执行）：
   ```bash
   xcopy /E /I models release\models
   ```

## 5. 打包完成后的检查清单

- [ ] `release/server/dist/app.js` 存在且可运行。
- [ ] `release/scripts` 内包含安装/启动/停止脚本。
- [ ] `release/tools/nssm.exe` 存在（或提供下载指引）。
- [ ] `release/env.template` 与 `.env` 差异已知，必要密钥未写入模板。
- [ ] `release/models/large-v3` 体积 ≈ 6GB（或根据模型大小确认）。
- [ ] 版本号、变更日志、构建日期记录在交付说明中。

## 6. 常见问题与排查

- **`npm run build` 报错**：查看 `dist/` 是否存在，若失败请运行 `npm run lint` / `npm test` 或手动排查 TypeScript 错误。
- **`..\models` 未被复制**：确认仓库根目录存在 `models/`。如果模型存储在外部磁盘，需要手动同步。
- **脚本找到的 Node 版本不正确**：检查系统 PATH，必要时在脚本前临时设置 `set PATH=C:\Program Files\nodejs;%PATH%`。
- **与 release 同步到 Git 导致体积过大**：`release/` 和 `models/` 均应在 `.gitignore` 中，交付时以压缩包或制品库发布。

## 7. 交付建议

| 内容 | 建议形式 |
| --- | --- |
| `release/` 目录 | ZIP 压缩（保留路径层级）|
| `models/` | 与 `release/` 同级放入 ZIP，或提供网盘/对象存储下载链接 |
| 安装说明 | 附带链接《后端服务安装指南》或 PDF |
| 校验 | 附上 MD5/SHA256 供实施团队验收 |

## 8. 下一步

- 将生成的 `release/` 交付给软件用户或实施工程师。
- 引导对方严格按照 `docs/kb/后端服务安装指南.md` 完成依赖安装、`.env` 配置、服务注册与验收。
