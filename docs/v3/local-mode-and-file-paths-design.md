# 本地模式与项目磁盘文件查看 - 功能设计

## 一、背景与目标

1. **本地模式**：当服务器、客户端、浏览器都在同一台机器时，希望**跳过上传步骤**，直接使用本机已有文件路径创建项目，从而**节省磁盘空间**（不复制一份到 uploads）。
2. **项目磁盘文件查看**：让用户能清楚看到「项目对应的文件在磁盘上的什么路径」，便于排查、备份或迁移。

---

## 二、本地模式设计

### 2.1 适用场景

- 用户在本机浏览器访问本机部署的 miaoji（例如 `http://localhost:5173` + 本机后端）。
- 媒体文件已经在本机磁盘上（如 `D:\Videos\xxx.mp4`），不需要再上传一份。

### 2.2 核心思路

- **不复制文件**：服务端只「登记」用户提供的本地路径，`media_files.filepath` 直接存该路径；转写、提取音频等仍按现有逻辑从该路径读文件。
- **可选：允许列表**：通过配置「允许的根路径」限制用户只能添加这些目录下的文件，避免任意路径带来的安全与隐私风险。

### 2.3 如何判定「本地模式」

可选方案（可只做一种，或组合）：

| 方案 | 说明 | 优点 | 缺点 |
|------|------|------|------|
| A. 环境变量/配置开关 | 如 `LOCAL_MODE=true` 或设置页「启用本地路径添加」 | 简单、可控 | 需用户或管理员显式开启 |
| B. 自动检测 | 根据请求来源 IP（如 `127.0.0.1` / `localhost`）判断是否本机访问 | 无需配置 | 反向代理、IPv6 等可能误判 |
| C. 仅开发/本机部署时启用 | 通过 `NODE_ENV` 或 `VITE_*` 判断 | 实现简单 | 生产同机部署时无法用 |

**建议**：以 **A（配置开关）** 为主；若有需要可再加 B 作为「当且仅当本机访问时自动显示本地路径入口」的增强，不单独作为唯一开关。

### 2.4 前端行为

- **上传页（UploadPage）**  
  - 当「本地模式」开启时，在上传区域旁增加**第二入口**：「从本地路径添加」。
  - 用户输入或粘贴**绝对路径**（如 `D:\Videos\demo.mp4` 或 `/home/user/videos/demo.mp4`）。
  - 前端调用新 API（见下），不传文件流，只传路径（及可选 original_name）。
  - 若当前未开启本地模式，则不展示该入口（或置灰并提示「仅在本机模式下可用」）。

- **与现有上传的关系**  
  - 保留原有「选择文件上传」流程不变；两种方式二选一即可。

### 2.5 后端 API 设计

- **新接口**：`POST /api/projects/from-local-path`（或 `/api/upload/local-path`）。
- **请求体**示例：  
  `{ "path": "D:\\Videos\\demo.mp4", "display_name": "可选显示名" }`
- **服务端逻辑要点**：
  1. **开关**：若未开启本地模式，直接 403/400，并返回明确错误信息。
  2. **路径校验**：  
     - 解析为绝对路径，规范化（含 .. 等）。  
     - 若配置了「允许的根路径」列表，则校验该路径必须落在某一根路径下，否则 400。  
     - 若未配置允许列表，可仅允许「当前配置的存储根路径及其子路径」或直接允许任意可读路径（文档中说明风险）。
  3. **存在性与类型**：  
     - 使用 `fs.existsSync` / `fs.statSync` 确认是文件且可读。  
     - 扩展名或 MIME 限制与现有上传一致（仅允许音视频类型）。
  4. **去重（可选）**：  
     - 对本地文件同样计算 `file_hash`（如 MD5），若库中已有相同 `file_hash` 且未强制覆盖，可返回与现有上传相同的「重复」语义（如 `status: 'duplicate'` + 已有项目 id），由前端决定是跳转已有项目还是强制新建。
  5. **写库**：  
     - 生成新项目 id（UUID）。  
     - `media_files` 插入一行：`filepath` = 用户给的路径，**不**复制、不移动文件；`filename` / `original_name` 可从路径 basename 或请求中的 display_name 来；其余字段（如 `file_hash`、`size`、`mime_type`、`status: 'pending'`）与现有逻辑一致。  
     - **不**在 `ProjectPathService` 下再建项目子目录存一份拷贝（即不复制到 uploads/<uuid>/original.xxx）。
  6. **任务**：  
     - 与上传流程一致：入队转写任务，payload 中 `filepath` 即为该本地路径；后续转写、提取音频等均从该路径读。  
     - **注意**：若当前实现中「提取音频」会写到一个固定项目目录（如 `uploads/<id>/audio.wav`），则保持不变即可——仅「原始媒体」不复制，提取产物仍可落在项目目录。

### 2.6 配置项设计

- **本地模式开关**  
  - 位置：服务端环境变量（如 `LOCAL_MODE=true`）或现有设置表 `settings`（如 `local_mode`）。  
  - 前端可通过现有「系统状态」或设置页的某 API 读取是否启用，以决定是否展示「从本地路径添加」。
- **允许的根路径（可选）**  
  - 配置项如 `LOCAL_MODE_ALLOWED_BASE_PATHS`（环境变量，逗号分隔）或设置表。  
  - 校验时：用户路径必须是以其中某一项为前缀的规范化路径。  
  - 不配置时行为需在设计中明确：例如「仅允许当前存储路径下」或「允许任意可读路径」（建议文档注明风险：如误删系统文件、隐私等）。

### 2.7 风险与约束

- **用户移动/删除文件**：若用户之后移动或删除了该本地文件，项目会变成「文件不存在」。可在项目详情或列表中标红提示「文件缺失」，并允许用户「重新指定路径」或删除项目。
- **权限**：服务端进程必须有该路径的读权限；Windows 下注意 UNC、符号链接等的处理。
- **安全**：禁止通过「本地路径」接口读敏感文件（如通过路径穿越或符号链接），必须严格规范化路径并做根路径白名单校验。

---

## 三、项目磁盘文件查看设计

### 3.1 现状

- 后端 `GET /api/projects/:id` 已返回 `filepath`、`audio_path`。
- 前端在 **ProjectActionDialog** 的「文件信息」里已展示「存储路径」（即 `filepath`）。

### 3.2 目标

- **单项目**：用户能明确看到该项目对应的「原始文件路径」「提取的音频路径」（若有）以及「项目目录」。
- **全局**：用户能在**一个集中入口**查看所有项目的磁盘路径，便于排查、备份或迁移。

### 3.3 单项目：在项目内展示路径

- **位置**：项目详情页（ProjectDetailPage）或现有「项目信息/操作」弹窗（ProjectActionDialog）中。
- **内容**（建议至少包含，按需只读展示）：  
  | 字段       | 说明                     | 数据来源 |
  |------------|--------------------------|----------|
  | 原始文件   | 当前用于转写/播放的媒体  | `filepath` |
  | 提取音频   | 若存在                   | `audio_path` |
  | 项目目录   | 该项目在磁盘上的目录     | 由 `filepath` 解析：`path.dirname(filepath)` 即 `{basePath}/{projectId}/` |

- **交互**：  
  - 路径可复制（如「复制路径」按钮）。  
  - 若文件不存在（`fs.existsSync` 为 false），可显示警告样式并提示「文件已移动或删除」。

**实现要点**：  
- 项目目录可由前端根据 `filepath` 解析（去掉末尾文件名），或由后端在 `GET /api/projects/:id` 中多返回一个 `project_dir` 字段（由 `ProjectPathService.parseBasePathFromPath` + `getProjectDir` 得到），这样更一致。

### 3.4 全局：集中查看所有项目路径

- **位置**：建议放在 **设置页（SettingsPage）** 中，新增一个 Tab，例如「**项目文件位置**」或「**磁盘文件**」。
- **内容**：  
  - 表格或列表：每一行对应一个项目。  
  - 列建议：**项目名称**（display_name / original_name）、**状态**、**原始文件路径**、**提取音频路径**（若有）、**项目目录**、**操作**（如「复制路径」「打开项目」）。  
  - 支持按项目名或路径搜索/过滤；可选分页（与现有项目列表一致）。
- **数据来源**：  
  - 新接口：`GET /api/projects/paths`（或 `GET /api/projects?fields=id,display_name,original_name,status,filepath,audio_path` 并在后端解析 project_dir）。  
  - 返回结构例如：  
    `{ data: [{ id, display_name, original_name, status, filepath, audio_path, project_dir }], pagination }`  
  - 若某路径在服务端检测到不存在，可带 `file_exists: false`，前端显示警告。

### 3.5 与「删除项目」的关系

- 删除项目时，若 `filepath` 落在「项目目录」内（即当前是上传拷贝），则删除项目目录；若是**本地模式**添加的外部路径，则**不删除**用户文件，只删库与项目目录内的衍生文件（如 audio.wav）。  
- 磁盘文件查看页可对「外部路径」做小标识（如图标或「外部文件」标签），避免用户误以为删除项目会删掉该文件。

---

## 四、实现顺序建议

1. **项目磁盘文件查看**  
   - 先做「单项目」：在详情/弹窗中补全 `audio_path`、`project_dir` 展示与复制。  
   - 再做「全局」：设置页新 Tab + `GET /api/projects/paths`（或扩展现有列表 API）。
2. **本地模式**  
   - 先做配置开关与后端 `POST /api/projects/from-local-path`（含路径校验、写库、入队）。  
   - 再在上传页根据开关显示「从本地路径添加」入口并联调。

---

## 五、小结

| 功能           | 核心点 |
|----------------|--------|
| 本地模式       | 通过配置开启；新 API 接收本地绝对路径，不复制文件，直接登记并转写；可选允许根路径白名单；前端上传页增加「从本地路径添加」入口。 |
| 单项目路径查看 | 在项目详情/弹窗中展示 filepath、audio_path、project_dir，支持复制；可对缺失文件做提示。 |
| 全局路径查看   | 设置页新 Tab「项目文件位置」，列表展示所有项目的路径与项目目录，支持搜索/分页与复制。 |

以上为设计说明，不涉及具体代码实现，便于后续按模块拆分任务与评审。
