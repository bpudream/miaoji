# 产品设计文档：足球/教育场景化转写增强 (Context-Aware Transcription)

| 文档版本 | V1.0 |
| --- | --- |
| **状态** | 待开发 |
| **优先级** | P0 (核心体验优化) |
| **涉及端** | 前端 (React), 后端 (Node.js), AI Worker (Python) |

## 1. 背景与目标

**背景**：
Faster-Whisper 模型在处理专有名词（如球员名“Szoboszlai”、节目名“Match Of The Day”）时，由于缺乏上下文，极易出现音译错误（幻觉）。

**目标**：
利用**用户显式输入的元数据**（文件名、对阵球队、名单、场景），在后端动态生成 `initial_prompt` 并注入模型，从而显著提高专有名词的识别准确率。

---

## 2. 用户流程 (User Flow)

1. **上传/设置**：用户上传视频（或在项目详情页点击“重新转写”）。
2. **选择场景**：用户在“场景模式”下拉框中选择“足球比赛”。
3. **补充信息**：
* 界面自动读取并展示**文件名**。
* 用户输入/选择 **主队** 和 **客队** 名称（如：Liverpool, Man Utd）。
* (可选) 用户粘贴 **关键名单** (Roster)。


4. **系统处理**：后端将上述信息熔炼成一段 Prompt。
5. **转写执行**：AI Worker 带着 Prompt 进行转写，输出准确的专有名词。

---

## 3. 功能需求详细说明

### 3.1 前端 (Frontend)

**位置**：新建项目弹窗 / 项目设置页 -> 转写配置卡片。

| 字段/组件 | 类型 | 交互逻辑 | 默认值 |
| --- | --- | --- | --- |
| **场景模式 (Scenario)** | Dropdown | 选项：`通用(Default)`、`足球比赛(Football)`、`教育/讲座(Education)`。<br>

<br>切换选项会改变下方显示的输入字段。 | `通用` |
| **文件名预览** | Text (Read-only) | 仅展示，提示用户文件名也将被用于辅助识别。 | 当前文件名 |
| **主队 (Home Team)** | Input / Select | **仅在“足球”模式显示**。<br>

<br>MVP阶段：文本输入框。<br>

<br>未来：从知识库选择。 | 空 |
| **客队 (Away Team)** | Input / Select | **仅在“足球”模式显示**。同上。 | 空 |
| **补充关键词/名单** | Textarea | **通用/教育模式**：Label 为“关键词”；<br>

<br>**足球模式**：Label 为“球员名单/术语”。<br>

<br>支持多行输入。 | 空 |

### 3.2 后端 (Node.js)

**核心逻辑**：在 `Queue.add` 之前，调用 `PromptBuilder` 生成提示词。

#### 3.2.1 接口变更

* **API**: `POST /api/projects/:id/transcribe` (或 upload payload)
* **新增字段**:
```json
{
  "scenario": "football", // enum: general, football, education
  "meta": {
    "team_home": "Liverpool",
    "team_away": "Man Utd",
    "keywords": "Klopp, Ten Hag, Szoboszlai..."
  }
}

```



#### 3.2.2 Prompt 组装算法 (PromptBuilder)

**约束**：Whisper Prompt 长度建议控制在 **200 tokens** (约 150 单词) 以内，过长会被截断。需包含截断逻辑。

**伪代码逻辑 (工程师参考)**：

```javascript
/**
 * 构建 initial_prompt
 * @param filename 文件名
 * @param scenario 场景
 * @param meta 用户填写的元数据 {team_home, team_away, keywords}
 */
function buildPrompt(filename, scenario, meta) {
    let promptParts = [];

    // 1. 基础语境 (Base Context)
    if (scenario === 'football') {
        promptParts.push("Context: Live football match commentary.");
        promptParts.push("Expect terms: Offside, VAR, Penalty, Corner kick, Goal.");
    } else if (scenario === 'education') {
        promptParts.push("Context: Educational lecture. Academic tone. Precise terminology.");
    }

    // 2. 文件名注入 (Filename Injection) - 清洗扩展名
    const cleanName = filename.replace(/\.(mp4|mp3|wav)$/i, '').replace(/_/g, ' ');
    promptParts.push(`Title: ${cleanName}.`);

    // 3. 结构化数据注入 (Structured Data)
    if (scenario === 'football' && meta.team_home && meta.team_away) {
        promptParts.push(`Match: ${meta.team_home} vs ${meta.team_away}.`);
    }

    // 4. 关键词/名单注入 (Keywords/Roster) - 高权重
    if (meta.keywords) {
        // 截取前 80 个字符，防止溢出
        const safeKeywords = meta.keywords.substring(0, 150);
        promptParts.push(`Keywords: ${safeKeywords}.`);
    }

    // 5. 合并
    return promptParts.join(" ");
}

```

### 3.3 AI Worker (Python)

* **输入**：接收 Node 传递的 `initial_prompt` 字符串。
* **动作**：直接透传给 `model.transcribe`。
* **注意**：无需处理截断，Node 端已处理。

---

## 4. 示例数据 (Case Study)

### 场景：英超双红会

* **文件名**：`MOTD_Liverpool_vs_ManUtd_Highlights.mp4`
* **用户输入**：
* 主队：`Liverpool`
* 客队：`Man Utd`
* 名单：`Salah, Nunez, Szoboszlai, Endo, Onana, Rashford, Maguire`



**生成的最终 Prompt**：

> "Context: Live football match commentary. Expect terms: Offside, VAR, Penalty, Corner kick, Goal. Title: MOTD Liverpool vs ManUtd Highlights. Match: Liverpool vs Man Utd. Keywords: Salah, Nunez, Szoboszlai, Endo, Onana, Rashford, Maguire."

**预期效果**：

* `MOTD` -> 识别为 **Match Of The Day** (因为 Title 里有)。
* `Soboslaii` (音译) -> 修正为 **Szoboszlai** (因为 Keywords 里有)。

---

## 5. 验收标准 (Acceptance Criteria)

1. **界面交互**：切换到“足球”模式时，必须出现球队输入框。
2. **参数透传**：在 Python Worker 的日志中，必须能看到拼接完整的 `initial_prompt` 字符串。
3. **截断保护**：如果用户在该字段粘贴了 5000 字的论文，后端必须截断，不能导致 Worker 报错或 Prompt 失效。
4. **效果验证**：使用测试视频（含生僻球员名），对比“不填名单”和“填名单”的转写结果，后者应准确输出该球员名。

---

## 6. 未来迭代 (Out of Scope for Sprint 02)

* **V1.1 球队知识库**：在 Settings 里配置常用的球队和名单，下拉框直接选择，不用每次打字。
* **V1.2 自动文件名解析**：利用 Regex 自动从文件名提取球队名（如从 `LIV_vs_MUN` 自动填入表单）。
