# Sprint 5: 功能完善与部署（Week 11-12）

### 目标
完善 MVP 功能，优化性能，部署到生产环境

### User Stories

#### US-5.1 文本编辑功能
**作为** 用户
**我想要** 编辑转写结果
**以便** 修正错误

**验收标准**:
- [ ] 可以编辑文本
- [ ] 自动保存
- [ ] 保留时间戳

**任务拆解**:
- [ ] Task-5.1.1: 实现文本编辑器组件（4h）
- [ ] Task-5.1.2: 实现自动保存（2h）
- [ ] Task-5.1.3: 实现更新 API（2h）
  - PUT /api/projects/:id/transcription
- [ ] Task-5.1.4: 添加撤销/重做功能（2h）
- [ ] Task-5.1.5: 扩展时间轴列宽与超长时间戳适配（2h）
  - 以 `999 min 00.0 s` 为基准重构栅格宽度，并对窄屏做响应式处理
- [ ] Task-5.1.6: 文本区信息头与过滤控件优化（3h）
  - 调整统计信息、搜索、筛选、视图密度切换的交互，确保编辑入口显眼且不打断阅读

---

#### US-5.2 导出功能
**作为** 用户
**我想要** 导出转写结果
**以便** 在其他软件中使用

**验收标准**:
- [ ] 支持 TXT 格式
- [ ] 支持 JSON 格式
- [ ] 支持 SRT 字幕格式（可选）

**任务拆解**:
- [ ] Task-5.2.1: 实现导出 API（3h）
  - GET /api/projects/:id/export?format=txt
- [ ] Task-5.2.2: 实现 TXT 导出（1h）
- [ ] Task-5.2.3: 实现 JSON 导出（1h）
- [ ] Task-5.2.4: 实现 SRT 导出（2h）
- [ ] Task-5.2.5: 前端添加导出按钮（1h）

---

#### US-5.3 错误处理与诊断优化
**作为** 系统管理员
**我想要** 系统能自我诊断并提供详细日志
**以便** 快速定位问题

**验收标准**:
- [ ] 所有错误都有提示
- [ ] 诊断文件（diagnostics）有清理机制

**任务拆解**:
- [ ] Task-5.3.1: 统一错误代码（2h）
- [ ] Task-5.3.2: 实现 Toast 提示组件（2h）
- [ ] Task-5.3.3: 实现诊断文件自动清理（Cron Job）（2h） - **[New]**
  - 清理 `server/diagnostics` 目录下超过 7 天的文件
- [ ] Task-5.3.4: 完善各接口错误处理（3h）

---

#### US-5.4 性能优化
**作为** 开发者
**我想要** 优化应用性能
**以便** 提供更好的用户体验

**验收标准**:
- [ ] 前端加载时间 < 2s
- [ ] API 响应时间 < 100ms
- [ ] GPU 利用率 > 80%

**任务拆解**:
- [ ] Task-5.4.1: 前端代码分割（2h）
- [ ] Task-5.4.2: 图片和资源优化（1h）
- [ ] Task-5.4.3: API 响应缓存（2h）
- [ ] Task-5.4.4: 数据库查询优化（2h）
- [ ] Task-5.4.5: GPU 显存监控与自动释放（3h） - **[Updated]**
  - 监控 Python Worker 显存占用

---

#### US-5.5 部署配置
**作为** 开发者
**我想要** 在生产环境部署应用
**以便** 实际使用

**验收标准**:
- [ ] PM2 配置完成
- [ ] 可以开机自启动
- [ ] 日志正常记录

**任务拆解**:
- [ ] Task-5.5.1: 创建 ecosystem.config.js（1h）
- [ ] Task-5.5.2: 配置环境变量（1h）
- [ ] Task-5.5.3: 编写启动脚本（1h）
- [ ] Task-5.5.4: 配置 PM2 开机自启（1h）
- [ ] Task-5.5.5: 配置 Windows 防火墙（30min）
- [ ] Task-5.5.6: 编写部署文档（2h）

---

#### US-5.6 测试与文档
**作为** 开发者
**我想要** 完整的测试和文档
**以便** 保证质量和可维护性

**验收标准**:
- [ ] 核心功能有单元测试
- [ ] API 文档完整
- [ ] 用户手册完成

**任务拆解**:
- [ ] Task-5.6.1: 编写后端单元测试（4h）
- [ ] Task-5.6.2: 编写前端组件测试（4h）
- [ ] Task-5.6.3: 编写 API 文档（2h）
- [ ] Task-5.6.4: 编写用户手册（3h）
- [ ] Task-5.6.5: 编写开发者文档（2h）

---

#### US-5.7 安全加固
**作为** 开发者
**我想要** 增强系统的安全性
**以便** 防止未授权访问和恶意攻击

**验收标准**:
- [ ] CORS 策略仅限受信任的来源
- [ ] 增加 API 速率限制 (Rate Limiting)
- [ ] 上传文件类型和大小的严格后端校验
- [ ] (可选) 简单的 API Token 认证机制

**任务拆解**:
- [ ] Task-5.7.1: 配置严格的 CORS 规则（允许 localhost 和局域网 IP 段）
- [ ] Task-5.7.2: 集成 @fastify/rate-limit 防止暴力请求
- [ ] Task-5.7.3: 完善文件上传的安全校验（Magic Number 检查文件头）
- [ ] Task-5.7.4: 实现简单的 Authorization Header 校验（如果在非家庭环境使用）

---

#### US-5.8 高级文件管理
**作为** 用户/系统管理员
**我想要** 更智能的文件存储策略
**以便** 节省空间并防止误删

**验收标准**:
- [ ] 重复文件上传时实现秒传（基于 Hash）
- [ ] 支持手动锁定文件（防止自动清理）
- [ ] 过期且未锁定文件自动清理
- [ ] 存储目录按日期分层（YYYY/MM/DD）

**任务拆解**:
- [ ] Task-5.8.1: 实现文件 SHA-256 计算与查重逻辑（2h）
  - 后端计算 Hash，如果存在则复用
- [ ] Task-5.8.2: 数据库迁移（1h）
  - 添加 `file_hash`, `is_locked` (default false), `expire_at` 字段
- [ ] Task-5.8.3: 实现文件锁定/解锁 API 及前端交互（2h）
  - `POST /api/projects/:id/lock`
- [ ] Task-5.8.4: 实现 Cron Job 定时清理过期文件（2h）
  - 每天凌晨运行，清理 `expire_at < now` AND `is_locked = false` 的物理文件
- [ ] Task-5.8.5: 优化上传存储路径逻辑（1h）
  - 使用 `uploads/YYYY/MM/DD/` 结构

---

**Sprint 5 总结**:
- **总估时**: 约 60-65 小时
- **关键交付物**:
  - ✅ MVP 功能完整
  - ✅ 性能优化完成
  - ✅ 部署到生产环境
  - ✅ 文档完善
  - ✅ 健壮的文件管理系统
