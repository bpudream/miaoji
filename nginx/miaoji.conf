# Nginx 配置文件：miaoji.conf

# 将此文件放在 Nginx 安装目录的 conf 文件夹中
# 例如：C:\nginx\conf\miaoji.conf
#
# 然后在 conf/nginx.conf 的 http 块中添加：
#   include miaoji.conf;

server {
    listen 80;
    server_name _;  # 接受所有域名/IP访问

    # 日志配置
    access_log logs/miaoji_access.log;
    error_log logs/miaoji_error.log;

    # 前端静态文件路径
    # ⚠️ 请修改为您的实际项目路径
    root C:/Users/bpudr/Documents/0.code/miaoji/web/dist;
    index index.html;

    # 妙记前端服务：部署在 /miaoji 路径下
    # 处理 /miaoji（无末尾斜杠）的情况，重定向到 /miaoji/
    location = /miaoji {
        return 301 /miaoji/;
    }

    # 处理 /miaoji/ 路径
    location /miaoji/ {
        alias C:/Users/bpudr/Documents/0.code/miaoji/web/dist/;
        try_files $uri $uri/ /miaoji/index.html;

        # 静态资源缓存
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 后端 API 反向代理：/miaoji/api/ 转发到后端
    location /miaoji/api/ {
        proxy_pass http://localhost:13636/api/;
        proxy_http_version 1.1;

        # 请求头设置（保持原始请求信息）
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置（大文件上传需要较长超时时间）
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # 文件上传大小限制（4GB，与后端配置一致）
        client_max_body_size 4G;
    }

    # 健康检查端点（可选，用于监控）
    location /miaoji/health {
        proxy_pass http://localhost:13636/api/health;
        access_log off;
    }

    # 根路径重定向到 /miaoji（可选，方便访问）
    location = / {
        return 301 /miaoji/;
    }
}

